<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zira Artifacts Admin Portal</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/logo.png') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0/dist/date-fns.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- Toastify.js -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <!-- Shared Stylesheet -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>
        /* Admin-Specific Styles */
body {
    font-family: 'Inter', sans-serif;
    overflow-x: hidden;
}

.container {
    display: flex;
    min-height: 100vh;
    flex-direction: column;
}

.sidebar {
    width: 16rem;
    background: #1f2937;
    color: white;
    transition: transform 0.3s ease;
    z-index: 50;
}

.sidebar-hidden {
    transform: translateX(-100%);
}

.main-content {
    flex: 1;
    padding: 1.5rem;
    background: #f3f4f6;
    overflow-y: auto;
}

.table-container {
    overflow-x: auto;
    width: 100%;
    margin-left: auto;
    margin-right: auto;
    -webkit-overflow-scrolling: touch;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-left: auto;
    margin-right: auto;
    table-layout: auto;
}

th, td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid #e5e7eb;
    white-space: normal;
    overflow-wrap: break-word;
}

th {
    background: #f9fafb;
    font-weight: 600;
}

.action-btn {
    transition: all 0.2s ease;
}

.action-btn:hover {
    transform: scale(1.1);
}

.image-preview {
    max-width: 100px;
    max-height: 100px;
    object-fit: cover;
    margin-top: 0.5rem;
}

.modal {
    padding: 1rem;
}

.modal-content {
    max-width: 95%;
    max-height: 85vh;
    overflow-y: auto;
    border-radius: 0.5rem;
}

/* Ensure toggle button is styled */
#toggle-sidebar {
    display: none;
    padding: 0.5rem;
    background: none;
    border: none;
    cursor: pointer;
}

@media (min-width: 768px) {
    .container {
        flex-direction: row;
    }

    .sidebar {
        position: sticky;
        top: 0;
        height: 100vh;
        overflow-y: auto;
    }

    .main-content {
        width: calc(100% - 16rem);
    }
}

@media (max-width: 767px) {
    #toggle-sidebar {
        display: block; /* Show toggle button on mobile */
    }

    .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100%;
        transform: translateX(-100%); /* Hidden by default */
    }

    .sidebar.show {
        transform: translateX(0); /* Show sidebar when toggled */
    }

    .main-content {
        width: 100%;
        padding: 1rem;
        margin-left: 0;
        min-height: 100vh;
    }

    .header-container {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
        padding: 0.5rem;
    }

    .header-container input {
        width: 100%;
        max-width: none;
    }

    /* Responsive tables */
    table {
        min-width: 600px; /* Ensure tables are scrollable */
    }

    th, td {
        padding: 0.5rem;
        font-size: 0.75rem;
        line-height: 1.2;
    }

    /* Dashboard cards */
    .grid-cols-1 {
        grid-template-columns: 1fr;
    }

    .grid-cols-2 {
        grid-template-columns: 1fr;
    }

    .grid-cols-4 {
        grid-template-columns: 1fr;
    }

    /* Modals */
    .modal-content {
        width: 90%;
        max-height: 80vh;
        padding: 1rem;
    }

    .modal-content h2 {
        font-size: 1.25rem;
    }

    .modal-content .modal-close {
        top: 0.5rem;
        right: 0.5rem;
    }

    .modal-content form {
        font-size: 0.875rem;
    }

    .modal-content input,
    .modal-content select,
    .modal-content textarea {
        font-size: 0.875rem;
    }

    /* Buttons */
    .action-btn {
        font-size: 0.875rem;
        padding: 0.25rem;
    }

    .image-preview {
        max-width: 80px;
        max-height: 80px;
    }

    /* Sidebar navigation */
    .sidebar nav ul li a {
        font-size: 0.875rem;
        padding: 0.5rem;
    }

    /* Charts */
    canvas {
        max-height: 200px;
    }

    /* Forms and buttons */
    button,
    input[type="submit"] {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
    }

    /* Search inputs */
    input[type="text"],
    input[type="search"] {
        padding: 0.5rem;
        font-size: 0.875rem;
    }

    /* Header alignment */
    .header-container .flex {
        flex-direction: column;
        align-items: flex-start;
        width: 100%;
    }

    .header-container .flex > div {
        width: 100%;
    }

    /* Sidebar logo and title */
    .sidebar .p-4 img {
        height: 2rem;
    }

    .sidebar .p-4 h1 {
        font-size: 1.25rem;
    }
}

/* Style for the close button */
#close-sidebar {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.5rem;
    transition: color 0.2s ease;
}

#close-sidebar:hover {
    color: #facc15; /* Yellow hover effect to match theme */
}

@media (min-width: 768px) {
    #close-sidebar {
        display: none; /* Ensure close button is hidden on larger screens */
    }
}
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar flex flex-col">
            <div class="p-4 flex items-center justify-between border-b border-gray-700">
                <div class="flex items-center space-x-2">
                    <img src="/static/images/logo.png" alt="Zira Artifacts Logo" class="h-10">
                    <h1 class="text-xl font-bold">Zira Admin</h1>
                </div>
                <button id="close-sidebar" class="md:hidden text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <nav class="flex-1 p-4">
                <ul class="space-y-2">
                    <li>
                        <a href="#" class="nav-link flex items-center space-x-2 p-2 rounded hover:bg-yellow-600" data-section="dashboard">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-link flex items-center space-x-2 p-2 rounded hover:bg-yellow-600" data-section="users">
                            <i class="fas fa-users"></i>
                            <span>Users</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-link flex items-center space-x-2 p-2 rounded hover:bg-yellow-600" data-section="products">
                            <i class="fas fa-box"></i>
                            <span>Products</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-link flex items-center space-x-2 p-2 rounded hover:bg-yellow-600" data-section="orders">
                            <i class="fas fa-shopping-cart"></i>
                            <span>Orders</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-link flex items-center space-x-2 p-2 rounded hover:bg-yellow-600" data-section="categories">
                            <i class="fas fa-tags"></i>
                            <span>Categories</span>
                        </a>
                    </li>
                    <li>
    <a href="#" class="nav-link flex items-center space-x-2 p-2 rounded hover:bg-yellow-600" data-section="subcategories">
        <i class="fas fa-list-ul"></i>
        <span>Subcategories</span>
    </a>
</li>
                    <li>
                        <a href="#" class="nav-link flex items-center space-x-2 p-2 rounded hover:bg-yellow-600" data-section="discounts">
                            <i class="fas fa-percent"></i>
                            <span>Discounts</span>
                        </a>
                    </li>
                    <li>
    <a href="#" class="nav-link flex items-center space-x-2 p-2 rounded hover:bg-yellow-600" data-section="gifts">
        <i class="fas fa-gift"></i>
        <span>Gifts</span>
    </a>
</li>
                    <li>
                        <a href="#" class="nav-link flex items-center space-x-2 p-2 rounded hover:bg-yellow-600" data-section="artisans">
                            <i class="fas fa-user-check"></i>
                            <span>Artisan Sellers</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-link flex items-center space-x-2 p-2 rounded hover:bg-yellow-600" data-section="stories">
                            <i class="fas fa-book"></i>
                            <span>Stories</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-link flex items-center space-x-2 p-2 rounded hover:bg-yellow-600" data-section="reviews">
                            <i class="fas fa-star"></i>
                            <span>Reviews</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-link flex items-center space-x-2 p-2 rounded hover:bg-yellow-600" data-section="passwords">
                            <i class="fas fa-lock"></i>
                            <span>Password Management</span>
                        </a>
                    </li>
                </ul>
            </nav>
            <div class="p-4 border-t border-gray-700">
                <a href="#" class="flex items-center space-x-2 p-2 rounded hover:bg-red-600" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </div>
        </aside>
        <script>
            // Close Sidebar Button
document.getElementById('close-sidebar').addEventListener('click', () => {
    document.querySelector('.sidebar').classList.remove('show');
});
// Sidebar Toggle
document.getElementById('toggle-sidebar').addEventListener('click', () => {
    const sidebar = document.querySelector('.sidebar');
    sidebar.classList.toggle('show');
});

// Close Sidebar Button
document.getElementById('close-sidebar').addEventListener('click', () => {
    document.querySelector('.sidebar').classList.remove('show');
});

        </script>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header-container flex flex-col md:flex-row items-center justify-between mb-6">
                <div class="flex items-center space-x-4 w-full md:w-auto justify-between md:justify-start">
                    <button id="toggle-sidebar" class="md:hidden text-gray-600">
                        <i class="fas fa-bars text-2xl"></i>
                    </button>
                    <h2 class="text-2xl font-semibold text-gray-800" id="section-title">Dashboard</h2>
                </div>
                <div class="flex items-center space-x-4 w-full md:w-auto">
                    <input type="text" id="global-search" placeholder="Search..." class="border rounded px-3 py-1 focus:outline-none focus:ring-2 focus:ring-yellow-600 w-full max-w-xs">
                    <!-- <i class="fas fa-user-circle text-2xl text-gray-600"></i> -->
                </div>
            </header>

            <!-- Sections -->
            <section id="dashboard" class="section">
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6 max-w-full mx-auto">
        <div class="bg-white p-4 rounded-lg shadow">
            <h3 class="text-lg font-semibold text-gray-800">Total Sales</h3>
            <p class="text-2xl font-bold text-yellow-600" id="total-sales">KSh 0</p>
        </div>
        <div class="bg-white p-4 rounded-lg shadow">
            <h3 class="text-lg font-semibold text-gray-800">New Users</h3>
            <p class="text-2xl font-bold text-yellow-600" id="new-users">0</p>
        </div>
        <div class="bg-white p-4 rounded-lg shadow">
            <h3 class="text-lg font-semibold text-gray-800">Pending Order Items</h3> <!-- Updated label -->
            <p class="text-2xl font-bold text-yellow-600" id="pending-orders">0</p>
        </div>
        <div class="bg-white p-4 rounded-lg shadow">
            <h3 class="text-lg font-semibold text-gray-800">Top Product</h3>
            <p class="text-2xl font-bold text-yellow-600" id="top-product">N/A</p>
        </div>
    </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 max-w-full mx-auto">
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Sales Over Time</h3>
                        <canvas id="sales-chart"></canvas>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">User Growth</h3>
                        <canvas id="users-chart"></canvas>
                    </div>
                </div>
            </section>

            <section id="users" class="section hidden">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 max-w-full mx-auto">
                    <h3 class="text-xl font-semibold">Manage Users</h3>
                    <button class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700 mt-2 sm:mt-0" onclick="openModal('user-modal')">Add User</button>
                </div>
                <input type="text" id="users-search" placeholder="Search users..." class="w-full max-w-md border rounded px-3 py-2 mb-4 mx-auto">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Phone Number</th>
                                <th>Role</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table"></tbody>
                    </table>
                </div>
            </section>

            <section id="products" class="section hidden">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 max-w-full mx-auto">
                    <h3 class="text-xl font-semibold">Manage Products</h3>
                    <button class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700 mt-2 sm:mt-0" onclick="openModal('product-modal')">Add Product</button>
                </div>
                <input type="text" id="products-search" placeholder="Search products..." class="w-full max-w-md border rounded px-3 py-2 mb-4 mx-auto">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Price</th>
                                <th>Discount</th>
                                <th>Image</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="products-table"></tbody>
                    </table>
                </div>
            </section>

            <section id="orders" class="section hidden">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 max-w-full mx-auto">
                    <h3 class="text-xl font-semibold">Manage Orders</h3>
                    <button class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700" onclick="openModal('manual-order-modal')">Create an Order</button>
                    <input type="text" id="orders-search" placeholder="Search orders..." class="w-full max-w-md border rounded px-3 py-2 mt-2 sm:mt-0">
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Customer Number</th>
                                <th>Location</th>
                                <th>Products</th> <!-- New column -->
                                <th>Total</th>
                                <th>Customer Status</th>
                                <th>Status</th>
                                <th>Payment Method</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table"></tbody>
                    </table>
                </div>
                
            </section>


            <section id="categories" class="section hidden">
    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 max-w-full mx-auto">
        <h3 class="text-xl font-semibold">Manage Categories</h3>
        <button class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700 mt-2 sm:mt-0" onclick="openModal('category-modal')">Add Category</button>
    </div>
    <input type="text" id="categories-search" placeholder="Search categories..." class="w-full max-w-md border rounded px-3 py-2 mb-4 mx-auto">
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Image</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="categories-table"></tbody>
        </table>
    </div>
</section>

            <section id="subcategories" class="section hidden">
    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 max-w-full mx-auto">
        <h3 class="text-xl font-semibold">Manage Subcategories</h3>
        <button class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700 mt-2 sm:mt-0" onclick="openModal('subcategory-modal')">Add Subcategory</button>
    </div>
    <input type="text" id="subcategories-search" placeholder="Search subcategories..." class="w-full max-w-md border rounded px-3 py-2 mb-4 mx-auto">
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Category</th>
                    <th>Description</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="subcategories-table"></tbody>
        </table>
    </div>
</section>

            <section id="discounts" class="section hidden">
    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 max-w-full mx-auto">
        <h3 class="text-xl font-semibold">Manage Discounts</h3>
        <button class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700 mt-2 sm:mt-0" onclick="openModal('discount-modal')">Add Discount</button>
    </div>
    <input type="text" id="discounts-search" placeholder="Search discounts..." class="w-full max-w-md border rounded px-3 py-2 mb-4 mx-auto">
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Product</th>
                    <th>Discount (%)</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="discounts-table"></tbody>
        </table>
    </div>
</section>
            <section id="artisans" class="section hidden">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 max-w-full mx-auto">
                    <h3 class="text-xl font-semibold">Manage Artisan Sellers</h3>
                    <button class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700 mt-2 sm:mt-0" onclick="openModal('artisan-modal')">Add Artisan Seller</button>
                </div>
                <input type="text" id="artisans-search" placeholder="Search artisans..." class="w-full max-w-md border rounded px-3 py-2 mt-2 sm:mt-0">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone Number</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="artisans-table"></tbody>
                    </table>
                </div>
            </section>

            <section id="stories" class="section hidden">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 max-w-full mx-auto">
                    <h3 class="text-xl font-semibold">Manage Stories</h3>
                    <button class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700 mt-2 sm:mt-0" onclick="openModal('admin-story-modal')">Add Story</button>
                </div>
                <input type="text" id="stories-search" placeholder="Search stories..." class="w-full max-w-md border rounded px-3 py-2 mb-4 mx-auto">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Title</th>
                                <th>Image</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="stories-table"></tbody>
                    </table>
                </div>
            </section>

            <section id="reviews" class="section hidden">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 max-w-full mx-auto">
                    <h3 class="text-xl font-semibold">Manage Reviews</h3>
                    <input type="text" id="reviews-search" placeholder="Search reviews..." class="w-full max-w-md border rounded px-3 py-2 mt-2 sm:mt-0">
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Product</th>
                                <th>Customer</th>
                                <th>Rating</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reviews-table"></tbody>
                    </table>
                </div>
            </section>

            <section id="passwords" class="section hidden">
                <div class="flex flex-col items-center mb-4 max-w-full mx-auto">
                    <h3 class="text-xl font-semibold mb-4">Change Admin Password</h3>
                    <form id="password-form" class="w-full max-w-md">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700">Current Password</label>
                            <input type="password" id="current-password" class="w-full border rounded px-3 py-2" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700">New Password</label>
                            <input type="password" id="new-password" class="w-full border rounded px-3 py-2" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700">Confirm New Password</label>
                            <input type="password" id="confirm-password" class="w-full border rounded px-3 py-2" required>
                        </div>
                        <div class="flex justify-end">
                            <button type="submit" class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700">Update Password</button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- gifts -->
<section id="gifts" class="section hidden">
    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 max-w-full mx-auto">
        <h3 class="text-xl font-semibold">Manage Gifts</h3>
        <button class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700 mt-2 sm:mt-0" onclick="openModal('gift-modal')">Add Gift</button>
    </div>
    <input type="text" id="gifts-search" placeholder="Search gifts..." class="w-full max-w-md border rounded px-3 py-2 mb-4 mx-auto">
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Product Name</th>
                    <th>Category</th>
                    <th>Subcategory</th>
                    <th>Price</th>
                    <th>Image</th>
                    <th>Description</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="gifts-table"></tbody>
        </table>
    </div>
</section>


        </main>
    </div>

    <!-- Modals -->
    <!-- User Modal -->
    <div id="user-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="modal-content relative bg-white rounded-lg p-6 w-full max-w-2xl animate-slideIn">
            <span class="modal-close absolute top-4 right-4 text-gray-600 hover:text-yellow-600 cursor-pointer transition-colors" onclick="closeModal('user-modal')"><i class="fas fa-times text-xl"></i></span>
            <h2 class="text-xl font-semibold mb-4 text-yellow-600" id="user-modal-title">Add User</h2>
            <form id="user-form">
                <input type="hidden" id="user-id">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Username</label>
                    <input type="text" id="user-username" class="w-full border rounded px-3 py-2" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Name</label>
                    <input type="text" id="user-name" class="w-full border rounded px-3 py-2" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="user-email" class="w-full border rounded px-3 py-2" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Phone Number</label>
                    <input type="tel" id="user-phone" class="w-full border rounded px-3 py-2" pattern="[0-9]{10,15}" title="Phone number should be 10-15 digits">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Role</label>
                    <select id="user-role" class="w-full border rounded px-3 py-2" required>
                        <option value="buyer">Buyer</option>
                        <option value="artisan">Artisan Seller</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400" onclick="closeModal('user-modal')">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700">Save</button>
                </div>
            </form>
        </div>
    </div>

   <!-- Product Modal -->
<div id="product-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 transition-opacity duration-300">
    <div class="modal-content relative bg-white rounded-lg p-6 w-full max-w-2xl animate-slideIn max-h-[85vh] overflow-y-auto">
        <span class="modal-close absolute top-4 right-4 text-gray-600 hover:text-yellow-600 cursor-pointer transition-colors" onclick="closeModal('product-modal')"><i class="fas fa-times text-xl"></i></span>
        <h2 class="text-xl font-semibold mb-4 text-yellow-600" id="product-modal-title">Add Product</h2>
        <form id="product-form" enctype="multipart/form-data">
            <input type="hidden" id="product-id">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">Name</label>
                <input type="text" id="product-name" name="title" class="w-full border rounded px-3 py-2" required>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">Category</label>
                <select id="product-category" name="category_id" class="w-full border rounded px-3 py-2" required></select>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">Subcategory</label>
                <select id="product-subcategory" name="subcategory_id" class="w-full border rounded px-3 py-2">
                    <option value="">None</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">Price (KSh)</label>
                <input type="number" id="product-price" name="price" class="w-full border rounded px-3 py-2" step="0.01" required>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">Description</label>
                <textarea id="product-description" name="description" class="w-full border rounded px-3 py-2" rows="4"></textarea>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">Image (Max 3MB, JPG/PNG)</label>
                <input type="file" id="product-image" name="image" accept="image/jpeg,image/png" class="w-full border rounded px-3 py-2">
                <img id="product-image-preview" class="image-preview hidden" src="" alt="Image Preview">
            </div>
            <div class="flex justify-end space-x-2">
                <button type="button" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400" onclick="closeModal('product-modal')">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Gift Modal -->
<div id="gift-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 transition-opacity duration-300">
    <div class="modal-content relative bg-white rounded-lg p-6 w-full max-w-2xl animate-slideIn max-h-[85vh] overflow-y-auto">
        <span class="modal-close absolute top-4 right-4 text-gray-600 hover:text-yellow-600 cursor-pointer transition-colors" onclick="closeModal('gift-modal')"><i class="fas fa-times text-xl"></i></span>
        <h2 class="text-xl font-semibold mb-4 text-yellow-600" id="gift-modal-title">Add Gift</h2>
        <form id="gift-form" enctype="multipart/form-data">
            <input type="hidden" id="gift-id">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">Product Name</label>
                <input type="text" id="gift-product-name" name="product_name" class="w-full border rounded px-3 py-2" required>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">Category</label>
                <select id="gift-category" name="category_id" class="w-full border rounded px-3 py-2" required></select>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">Subcategory</label>
                <select id="gift-subcategory" name="subcategory_id" class="w-full border rounded px-3 py-2">
                    <option value="">None</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">Description</label>
                <textarea id="gift-description" name="description" class="w-full border rounded px-3 py-2" rows="4" required></textarea>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">Price (KSh)</label>
                <input type="number" id="gift-price" name="price" class="w-full border rounded px-3 py-2" step="0.01" required>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">Start Date</label>
                <input type="date" id="gift-start-date" name="start_date" class="w-full border rounded px-3 py-2" required>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">End Date</label>
                <input type="date" id="gift-end-date" name="end_date" class="w-full border rounded px-3 py-2" required>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">Image (Max 3MB, JPG/PNG)</label>
                <input type="file" id="gift-image" name="image" accept="image/jpeg,image/png" class="w-full border rounded px-3 py-2">
                <img id="gift-image-preview" class="image-preview hidden" src="" alt="Image Preview">
            </div>
            <div class="flex justify-end space-x-2">
                <button type="button" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400" onclick="closeModal('gift-modal')">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700">Save</button>
            </div>
        </form>
    </div>
</div>

    <!-- Category Modal -->
    <div id="category-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 transition-opacity duration-300">
    <div class="modal-content relative bg-white rounded-lg p-6 w-full max-w-2xl animate-slideIn max-h-[85vh] overflow-y-auto">
        <span class="modal-close absolute top-4 right-4 text-gray-600 hover:text-yellow-600 cursor-pointer transition-colors" onclick="closeModal('category-modal')"><i class="fas fa-times text-xl"></i></span>
        <h2 class="text-xl font-semibold mb-4 text-yellow-600" id="category-modal-title">Add Category</h2>
        <form id="category-form" enctype="multipart/form-data">
            <input type="hidden" id="category-id">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">Name</label>
                <input type="text" id="category-name" name="name" class="w-full border rounded px-3 py-2" required>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">Description</label>
                <textarea id="category-description" name="description" class="w-full border rounded px-3 py-2" rows="4"></textarea>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">Image (Max 3MB, JPG/PNG)</label>
                <input type="file" id="category-image" name="image" accept="image/jpeg,image/png" class="w-full border rounded px-3 py-2">
                <img id="category-image-preview" class="image-preview hidden" src="" alt="Image Preview">
            </div>
            <div class="flex justify-end space-x-2">
                <button type="button" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400" onclick="closeModal('category-modal')">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700">Save</button>
            </div>
        </form>
    </div>
</div>

    <!-- Subcategory Modal -->
<div id="subcategory-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 transition-opacity duration-300">
    <div class="modal-content relative bg-white rounded-lg p-6 w-full max-w-2xl animate-slideIn">
        <span class="modal-close absolute top-4 right-4 text-gray-600 hover:text-yellow-600 cursor-pointer transition-colors" onclick="closeModal('subcategory-modal')"><i class="fas fa-times text-xl"></i></span>
        <h2 class="text-xl font-semibold mb-4 text-yellow-600" id="subcategory-modal-title">Add Subcategory</h2>
        <form id="subcategory-form">
            <input type="hidden" id="subcategory-id">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">Category</label>
                <select id="subcategory-category" name="category_id" class="w-full border rounded px-3 py-2" required></select>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">Name</label>
                <input type="text" id="subcategory-name" name="name" class="w-full border rounded px-3 py-2" required>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">Description</label>
                <textarea id="subcategory-description" name="description" class="w-full border rounded px-3 py-2" rows="4"></textarea>
            </div>
            <div class="flex justify-end space-x-2">
                <button type="button" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400" onclick="closeModal('subcategory-modal')">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700">Save</button>
            </div>
        </form>
    </div>
</div>

    <!-- Discount Modal -->
    <div id="discount-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="modal-content relative bg-white rounded-lg p-6 w-full max-w-2xl animate-slideIn">
            <span class="modal-close absolute top-4 right-4 text-gray-600 hover:text-yellow-600 cursor-pointer transition-colors" onclick="closeModal('discount-modal')"><i class="fas fa-times text-xl"></i></span>
            <h2 class="text-xl font-semibold mb-4 text-yellow-600" id="discount-modal-title">Add Discount</h2>
            <form id="discount-form">
                <input type="hidden" id="discount-id">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Product</label>
                    <select id="discount-product" class="w-full border rounded px-3 py-2" required></select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Discount (%)</label>
                    <input type="number" id="discount-percent" class="w-full border rounded px-3 py-2" min="0" max="100" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Start Date</label>
                    <input type="date" id="discount-start" class="w-full border rounded px-3 py-2" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">End Date</label>
                    <input type="date" id="discount-end" class="w-full border rounded px-3 py-2" required>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400" onclick="closeModal('discount-modal')">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Artisan Modal -->
    <div id="artisan-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="modal-content relative bg-white rounded-lg p-6 w-full max-w-2xl animate-slideIn">
            <span class="modal-close absolute top-4 right-4 text-gray-600 hover:text-yellow-600 cursor-pointer transition-colors" onclick="closeModal('artisan-modal')"><i class="fas fa-times text-xl"></i></span>
            <h2 class="text-xl font-semibold mb-4 text-yellow-600" id="artisan-modal-title">Add Artisan Seller</h2>
            <form id="artisan-form">
                <input type="hidden" id="artisan-id">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Name</label>
                    <input type="text" id="artisan-name" class="w-full border rounded px-3 py-2" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="artisan-email" class="w-full border rounded px-3 py-2" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Phone Number</label>
                    <input type="tel" id="artisan-phone" class="w-full border rounded px-3 py-2" pattern="[0-9]{10,15}" title="Phone number should be 10-15 digits">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Status</label>
                    <select id="artisan-status" class="w-full border rounded px-3 py-2" required>
                        <option value="Pending">Pending</option>
                        <option value="Approved">Approved</option>
                        <option value="Suspended">Suspended</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400" onclick="closeModal('artisan-modal')">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Admin Story Modal -->
    <div id="admin-story-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="modal-content relative bg-white rounded-lg p-6 w-full max-w-2xl animate-slideIn">
            <span class="modal-close absolute top-4 right-4 text-gray-600 hover:text-yellow-600 cursor-pointer transition-colors" onclick="closeModal('admin-story-modal')"><i class="fas fa-times text-xl"></i></span>
            <h2 class="text-xl font-semibold mb-4 text-yellow-600" id="admin-story-modal-title">Add Story</h2>
            <form id="admin-story-form" enctype="multipart/form-data">
                <input type="hidden" id="admin-story-id">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Title</label>
                    <input type="text" id="admin-story-title" name="title" class="w-full border rounded px-3 py-2" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Content</label>
                    <textarea id="admin-story-content" name="content" class="w-full border rounded px-3 py-2" rows="5" required></textarea>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Image (Max 3MB, JPG/PNG)</label>
                    <input type="file" id="admin-story-image" name="image" accept="image/jpeg,image/png" class="w-full border rounded px-3 py-2">
                    <img id="admin-story-image-preview" class="image-preview hidden" src="" alt="Image Preview">
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400" onclick="closeModal('admin-story-modal')">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700">Save</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Manual Order Modal -->
<div id="manual-order-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 transition-opacity duration-300">
    <div class="modal-content relative bg-white rounded-lg p-6 w-full max-w-2xl animate-slideIn max-h-[85vh] overflow-y-auto">
        <span class="modal-close absolute top-4 right-4 text-gray-600 hover:text-yellow-600 cursor-pointer transition-colors" onclick="closeModal('manual-order-modal')"><i class="fas fa-times text-xl"></i></span>
        <h2 class="text-xl font-semibold mb-4 text-yellow-600" id="manual-order-modal-title">Create Manual Order</h2>
        <form id="manual-order-form">
            <!-- Customer Details -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">Customer Name</label>
                <input type="text" id="order-customer-name" name="customer_name" class="w-full border rounded px-3 py-2" required maxlength="100">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">Customer Phone Number</label>
                <input type="tel" id="order-customer-number" name="customer_number" class="w-full border rounded px-3 py-2" maxlength="15" pattern="[0-9+]{0,15}" title="Phone number should be up to 15 digits, may include '+'">
            </div>

            <!-- Payment Method -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">Payment Method</label>
                <select id="order-payment-method" name="payment_method" class="w-full border rounded px-3 py-2" required>
                    <option value="">Select Payment Method</option>
                    <option value="immediate">Immediate</option>
                    <option value="delivery">On Delivery</option>
                </select>
            </div>

            <!-- Message Code (Hidden by Default) -->
            <div class="mb-4 hidden" id="message-code-group">
                <label class="block text-sm font-medium text-gray-700">Message Code</label>
                <input type="text" id="order-message-code" name="message_code" class="w-full border rounded px-3 py-2">
            </div>

            <!-- Product Selection -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">Products</label>
                <div id="product-list" class="space-y-2"></div>
                <button type="button" id="add-product-btn" class="mt-2 inline-flex items-center px-3 py-1 bg-yellow-600 text-white rounded hover:bg-yellow-700 text-sm">
                    <i class="fas fa-plus mr-1"></i> Add Product
                </button>
            </div>

            <!-- Form Buttons -->
            <div class="flex justify-end space-x-2">
                <button type="button" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400" onclick="closeModal('manual-order-modal')">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700">Create Order</button>
            </div>
        </form>
    </div>
</div>

    <script>
// Manual Order Modal Functions
async function initializeManualOrderModal() {
    const productList = document.getElementById('product-list');
    const addProductBtn = document.getElementById('add-product-btn');
    const paymentMethodSelect = document.getElementById('order-payment-method');
    const messageCodeGroup = document.getElementById('message-code-group');
    const manualOrderForm = document.getElementById('manual-order-form');
    let productsData = [];

    // Fetch products
    try {
        productsData = await fetchData('discounted_artefacts');
        if (productsData.length === 0) {
            showToast('No products available', 'error');
        }
    } catch (error) {
        showToast('Failed to load products', 'error');
        console.error('Error fetching products:', error);
    }

    // Add product row
    function addProductRow() {
        const row = document.createElement('div');
        row.className = 'flex items-center space-x-2 product-row';
        row.innerHTML = `
            <select name="product_id" class="w-3/5 border rounded px-3 py-2" required>
                <option value="">Select Product</option>
                ${productsData.map(product => `<option value="${product.id}">${product.name} (KSh ${product.price.toFixed(2)}${product.discount ? `, ${product.discount}% off` : ''})</option>`).join('')}
            </select>
            <input type="number" name="quantity" min="1" value="1" class="w-1/5 border rounded px-3 py-2" required>
            <button type="button" class="remove-product-btn inline-flex items-center px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700">
                <i class="fas fa-trash"></i>
            </button>
        `;
        productList.appendChild(row);

        // Handle remove button
        row.querySelector('.remove-product-btn').addEventListener('click', () => {
            if (productList.children.length > 1) {
                row.remove();
            } else {
                showToast('At least one product is required', 'error');
            }
        });
    }

    // Initialize with one product row
    if (productsData.length > 0) {
        addProductRow();
    }

    // Handle add product button
    addProductBtn.addEventListener('click', addProductRow);

    // Show/hide message code field
    paymentMethodSelect.addEventListener('change', () => {
        const isImmediate = paymentMethodSelect.value === 'immediate';
        messageCodeGroup.classList.toggle('hidden', !isImmediate);
        document.getElementById('order-message-code').required = isImmediate;
    });

    // Handle form submission
    manualOrderForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(manualOrderForm);
        const products = [];
        const productRows = productList.querySelectorAll('.product-row');

        // Collect products
        productRows.forEach(row => {
            const productId = row.querySelector('select[name="product_id"]').value;
            const quantity = parseInt(row.querySelector('input[name="quantity"]').value);
            if (productId && quantity > 0) {
                products.push({ product_id: parseInt(productId), quantity });
            }
        });

        if (products.length === 0) {
            showToast('At least one valid product is required', 'error');
            return;
        }

        // Prepare data
        const data = {
            customer_name: formData.get('customer_name').trim(),
            customer_number: formData.get('customer_number').trim(),
            payment_method: formData.get('payment_method'),
            message_code: formData.get('message_code') || '',
            products
        };

        try {
            const response = await fetch('/api/manual_orders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
                credentials: 'include'
            });

            if (response.redirected && response.url.includes('/login')) {
                showToast('Session expired. Please log in.', 'error');
                window.location.href = '/login';
                return;
            }

            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'Failed to create order');

            showToast(`Order created successfully! Order ID: ${result.order_id}`);
            closeModal('manual-order-modal');
            await populateOrders(); // Refresh orders table
            await fetchDashboardStats(); // Update pending orders count
        } catch (error) {
            showToast(error.message, 'error');
            console.error('Error creating order:', error);
        }
    });
}

// Reset Manual Order Form
function resetManualOrderForm() {
    const form = document.getElementById('manual-order-form');
    const productList = document.getElementById('product-list');
    if (form && productList) {
        form.reset();
        productList.innerHTML = ''; // Clear product rows
        document.getElementById('message-code-group').classList.add('hidden');
        document.getElementById('order-message-code').required = false;

        // Re-add one product row
        const addProductBtn = document.getElementById('add-product-btn');
        if (addProductBtn) {
            addProductBtn.click(); // Trigger add product to create one row
        }
    }
}
        // Initialize Charts
let salesChart, usersChart;

function initializeCharts(salesData, usersData) {
    const salesCtx = document.getElementById('sales-chart').getContext('2d');
    const usersCtx = document.getElementById('users-chart').getContext('2d');

    // Update Sales Chart (Line Graph)
    if (!salesChart) {
        salesChart = new Chart(salesCtx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Sales (KSh)',
                    data: salesData.map(d => ({ x: new Date(d.date), y: d.total })),
                    borderColor: '#d97706',
                    backgroundColor: 'rgba(217, 119, 6, 0.2)',
                    fill: false,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                            displayFormats: {
                                day: 'yyyy-MM-dd'
                            }
                        },
                        title: { display: true, text: 'Date' }
                    },
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Sales (KSh)' }
                    }
                },
                plugins: {
                    legend: { display: true }
                }
            }
        });
    } else {
        salesChart.data.datasets[0].data = salesData.map(d => ({ x: new Date(d.date), y: d.total }));
        salesChart.update();
    }

    // Update Users Chart (Bar Chart)
    if (!usersChart) {
        usersChart = new Chart(usersCtx, {
            type: 'bar',
            data: {
                datasets: [{
                    label: 'User Growth',
                    data: usersData.map(d => ({ x: new Date(d.date), y: d.count })),
                    backgroundColor: '#2563eb',
                    borderColor: '#2563eb',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                            displayFormats: {
                                day: 'yyyy-MM-dd'
                            }
                        },
                        title: { display: true, text: 'Date' }
                    },
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'New Users' }
                    }
                },
                plugins: {
                    legend: { display: true }
                }
            }
        });
    } else {
        usersChart.data.datasets[0].data = usersData.map(d => ({ x: new Date(d.date), y: d.count }));
        usersChart.update();
    }
}

// Fetch Dashboard Stats
async function fetchDashboardStats() {
    try {
        console.log('Fetching /api/dashboard_stats...');
        const response = await fetch('/api/dashboard_stats', { credentials: 'include' });
        if (response.redirected) {
            console.warn('Redirected to:', response.url);
            showToast('Session expired or invalid. Please log in.', 'error');
            window.location.href = '/login';
            return;
        }
        const data = await response.json();
        if (!response.ok) {
            console.error('Dashboard stats error:', data.error);
            throw new Error(data.error || 'Failed to fetch dashboard stats');
        }
        console.log('Dashboard stats:', data);

        // Update dashboard cards
        document.getElementById('total-sales').textContent = `KSh ${data.total_sales.toFixed(2)}`;
        document.getElementById('new-users').textContent = data.new_users;
        document.getElementById('pending-orders').textContent = data.pending_orders;
        document.getElementById('top-product').textContent = data.top_product || 'None';

        // Initialize or update charts
        initializeCharts(data.sales_data || [], data.users_data || []);
    } catch (error) {
        console.error('Error in fetchDashboardStats:', error);
        showToast('Your internet connection is not stable: ','error');
    }
}

// Start polling for real-time updates
function startPolling() {
    fetchDashboardStats(); // Initial fetch
    setInterval(fetchDashboardStats, 30000); // Poll every 30 seconds
}

// Navigation
document.querySelectorAll('.nav-link').forEach(link => {
    link.addEventListener('click', e => {
        e.preventDefault();
        const section = link.dataset.section;
        document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
        document.getElementById(section).classList.remove('hidden');
        document.getElementById('section-title').textContent = section.charAt(0).toUpperCase() + section.slice(1);
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('bg-yellow-600'));
        link.classList.add('bg-yellow-600');
        if (window.innerWidth < 768) {
            document.querySelector('.sidebar').classList.add('sidebar-hidden');
        }
    });
});

// Sidebar Toggle
document.getElementById('toggle-sidebar').addEventListener('click', () => {
    const sidebar = document.querySelector('.sidebar');
    sidebar.classList.toggle('show');
});

// Modal Functions
function openModal(modalId) {
    console.log('Opening modal:', modalId);
    const modal = document.getElementById(modalId);
    modal.classList.remove('hidden');
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
    setTimeout(() => {
        console.log('Modal classes after open:', modal.classList.toString());
        if (modalId === 'product-modal') {
            populateProductCategories();
        } else if (modalId === 'discount-modal') {
            populateDiscountProducts();
        } else if (modalId === 'subcategory-modal') {
            populateSubcategoryCategories();
        } else if (modalId === 'gift-modal') {
            populateGiftCategories();
        }
    }, 0);
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.remove('show');
    modal.classList.add('hidden');
    document.body.style.overflow = 'auto';
    resetForm(modalId);
}

function resetForm(modalId) {
    if (modalId === 'manual-order-modal') {
        resetManualOrderForm();
        return;
    }
    const form = document.getElementById(modalId.replace('modal', 'form'));
    if (form) {
        form.reset();
        form.querySelector('input[type="hidden"]').value = '';
        const preview = document.getElementById(`${modalId.replace('modal', 'image')}-preview`);
        if (preview) {
            preview.classList.add('hidden');
            preview.src = '';
        }
        if (modalId === 'category-modal') {
            document.getElementById('category-description').value = '';
        }
        document.getElementById(modalId + '-title').textContent = `Add ${modalId.split('-')[0].charAt(0).toUpperCase() + modalId.split('-')[0].slice(1)}`;
    }
}

// Close Modal on Outside Click
document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeModal(modal.id);
        }
    });
});

// Toast Notifications
function showToast(message, type = 'success') {
    Toastify({
        text: message,
        duration: 3000,
        style: {
            background: type === 'success' ? '#d97706' : '#dc2626'
        }
    }).showToast();
}

// Image Validation and Preview
function validateAndPreviewImage(input, previewId) {
    const file = input.files[0];
    const preview = document.getElementById(previewId);
    if (file) {
        if (!['image/jpeg', 'image/png'].includes(file.type)) {
            showToast('Only JPG and PNG images are allowed', 'error');
            input.value = '';
            preview.classList.add('hidden');
            return false;
        }
        if (file.size > 3 * 1024 * 1024) {
            showToast('Image size must be less than 3MB', 'error');
            input.value = '';
            preview.classList.add('hidden');
            return false;
        }
        const reader = new FileReader();
        reader.onload = e => {
            preview.src = e.target.result;
            preview.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
        return true;
    }
    preview.classList.add('hidden');
    return false;
}

document.getElementById('product-image').addEventListener('change', e => {
    validateAndPreviewImage(e.target, 'product-image-preview');
});

document.getElementById('admin-story-image').addEventListener('change', e => {
    validateAndPreviewImage(e.target, 'admin-story-image-preview');
});

// Fetch Data (Enhanced to log response issues)
async function fetchData(endpoint) {
    try {
        console.log(`Fetching /api/${endpoint}...`);
        const response = await fetch(`/api/${endpoint}`, { credentials: 'include' });
        if (response.redirected && response.url.includes('/login')) {
            showToast('Session expired. Please log in.', 'error');
            window.location.href = '/login';
            return [];
        }
        if (!response.ok) {
            const data = await response.json();
            console.warn(`Failed to fetch /api/${endpoint}:`, data.error || 'Unknown error');
            showToast(`Failed to load ${endpoint}`, 'error');
            return [];
        }
        const data = await response.json();
        console.log(`Data from /api/${endpoint}:`, data);
        return Array.isArray(data) ? data : [];
    } catch (error) {
        console.error(`Error fetching /api/${endpoint}:`, error);
        showToast(`Failed to fetch ${endpoint}`, 'error');
        return [];
    }
}


window.onerror = function(message, source, lineno, colno, error) {
    console.error(`Global error: ${message} at ${source}:${lineno}:${colno}`, error);
};

// Populate Tables
async function populateUsers(data) {
    try {
        const users = data || await fetchData('users');
        const tbody = document.getElementById('users-table');
        tbody.innerHTML = users.map(user => `
            <tr>
                <td>${user.id}</td>
                <td>${user.username}</td>
                <td>${user.email}</td>
                <td>${user.phone_number || 'N/A'}</td>
                <td>${user.role}</td>
                <td>
                    <button class="action-btn text-blue-600 hover:text-blue-800" onclick="editUser(${user.id})"><i class="fas fa-edit"></i></button>
                    <button class="action-btn text-red-600 hover:text-red-800" onclick="deleteUser(${user.id})"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
        `).join('');
    } catch (error) {
        showToast(error.message, 'error');
    }
}

// Populate Products (Handle missing fields and normalize data)
async function populateProducts(data) {
    try {
        const products = data || await fetchData('discounted_artefacts');
        const tbody = document.getElementById('products-table');
        if (!products.length) {
            tbody.innerHTML = '<tr><td colspan="8">No products available</td></tr>';
            return;
        }
        // Fetch categories to map category_id to name
        const categories = await fetchData('categories');
        const categoryMap = categories.reduce((map, cat) => {
            map[cat.id] = cat.name;
            return map;
        }, {});
        tbody.innerHTML = products.map(product => {
            const discount = product.discount && typeof product.discount === 'object' && product.discount.percent
                ? `${parseFloat(product.discount.percent).toFixed(2)}%`
                : '0.00%';
            return `
                <tr>
                    <td>${product.id}</td>
                    <td>${product.name || product.title || 'N/A'}</td>
                    <td>${categoryMap[product.category_id] || 'N/A'}</td>
                    <td>KSh ${(product.price || 0).toFixed(2)}</td>
                    <td>${discount}</td>
                    <td>${product.image ? `<img src="/static/uploads/${product.image}" alt="${product.name || product.title}" class="image-preview" onerror="this.src='/static/placeholder.jpg'">` : 'No Image'}</td>
                    <td>${product.description || 'N/A'}</td>
                    <td>
                        <button class="action-btn text-blue-600 hover:text-blue-800" onclick="editProduct(${product.id})"><i class="fas fa-edit"></i></button>
                        <button class="action-btn text-red-600 hover:text-red-800" onclick="deleteProduct(${product.id})"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `;
        }).join('');
    } catch (error) {
        showToast('Failed to load products: ' + error.message, 'error');
        document.getElementById('products-table').innerHTML = '<tr><td colspan="8">Unable to load products</td></tr>';
    }
}

async function populateOrders(data) {
    try {
        console.log('Populating orders...');
        const orders = data || await fetchData('orders');
        console.log('Fetched orders:', orders);
        const tbody = document.getElementById('orders-table');
        if (!tbody) {
            console.error('Orders table not found');
            showToast('Failed to load orders table', 'error');
            return;
        }
        const orderRows = Array.isArray(orders) ? orders : [];
        tbody.innerHTML = orderRows.length > 0 ? orderRows.map(order => {
            const productsList = order.items && Array.isArray(order.items) ? 
                order.items.map(item => `${item.product_name} (x${item.quantity})`).join(', ') : 
                'No items';
            // Format location as a string
            const location = order.location && typeof order.location === 'object' ? 
                `${order.location.street || ''}, ${order.location.city || ''}, ${order.location.country || ''}${order.location.postal_code ? ', ' + order.location.postal_code : ''}`.trim().replace(/^,+|,+$/g, '') 
                : 'N/A';
            return `
                <tr>
                    <td>${order.id || 'N/A'}</td>
                    <td>${order.customer || 'Unknown'}</td>
                    <td>${order.customer_number || 'N/A'}</td>
                    <td>${location}</td>
                    <td>${productsList}</td>
                    <td>KSh ${order.total ? order.total.toFixed(2) : '0.00'}</td>
                    <td>${order.customer_status || 'Unknown'}</td>
                    <td>
                        <select onchange="updateOrderStatus('${order.id || 0}', this.value)">
                            <option value="Pending" ${order.status === 'Pending' ? 'selected' : ''}>Pending</option>
                            <option value="Shipped" ${order.status === 'Shipped' ? 'selected' : ''}>Shipped</option>
                            <option value="Delivered" ${order.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                            <option value="Canceled" ${order.status === 'Canceled' ? 'selected' : ''}>Canceled</option>
                        </select>
                    </td>
                    <td>${order.payment_method || 'N/A'}</td>
                    <td>
                        <button class="action-btn text-blue-600 hover:text-blue-800" onclick="viewOrder('${order.id || 0}')"><i class="fas fa-eye"></i></button>
                        <button class="action-btn text-red-600 hover:text-red-800" onclick="deleteOrder('${order.id || 0}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `;
        }).join('') : '<tr><td colspan="10">No orders available</td></tr>';
    } catch (error) {
        console.error('Error populating orders:', error);
        showToast('Failed to load orders', 'error');
        const tbody = document.getElementById('orders-table');
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="10">Unable to load orders. Please try again later.</td></tr>';
        }
    }
}

async function updateOrderStatus(orderId, status) {
    try {
        const response = await fetch(`/api/orders/${orderId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status }),
            credentials: 'include'
        });
        if (response.redirected && response.url.includes('/login')) {
            showToast('Session expired. Please log in.', 'error');
            window.location.href = '/login';
            return;
        }
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Update failed');
        showToast('Order status updated');
    } catch (error) {
        showToast(error.message, 'error');
    }
}

function pollOrders() {
    setInterval(async () => {
        if (document.getElementById('orders').classList.contains('hidden')) return;
        await populateOrders();
    }, 30000); // Poll every 30 seconds
}

async function deleteOrder(orderId) {
    if (confirm('Are you sure you want to delete this order?')) {
        try {
            const response = await fetch(`/api/orders/${orderId}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include'
            });
            if (response.redirected && response.url.includes('/login')) {
                showToast('Session expired. Please log in.', 'error');
                window.location.href = '/login';
                return;
            }
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Delete failed');
            showToast('Order deleted successfully');
            await populateOrders();
            await fetchDashboardStats(); // Update pending orders count
        } catch (error) {
            showToast(error.message, 'error');
        }
    }
}

// Populate Categories Table
async function populateCategories() {
    try {
        const categories = await fetchData('categories');
        const tbody = document.getElementById('categories-table');
        tbody.innerHTML = categories.map(category => `
            <tr>
                <td>${category.id}</td>
                <td>${category.name}</td>
                <td>${category.description || 'N/A'}</td>
                <td>${category.image ? `<img src="/static/uploads/${category.image}" alt="${category.name}" class="image-preview" onerror="this.src='/static/uploads/default_category.jpg'">` : 'No Image'}</td>
                <td>
                    <button class="action-btn text-blue-600 hover:text-blue-800" onclick="editCategory(${category.id})"><i class="fas fa-edit"></i></button>
                    <button class="action-btn text-red-600 hover:text-red-800" onclick="deleteCategory(${category.id})"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
        `).join('');
    } catch (error) {
        showToast(error.message, 'error');
    }
}



   // Populate Discounts (Map product_id and normalize dates)
async function populateDiscounts() {
    try {
        const discounts = await fetchData('discounts');
        const products = await fetchData('discounted_artefacts');
        const productMap = products.reduce((map, product) => {
            map[product.id] = product.name || product.title || 'Unknown Product';
            return map;
        }, {});
        const tbody = document.getElementById('discounts-table');
        tbody.innerHTML = discounts.length > 0 ? discounts.map(discount => {
            // Use productName from backend if available, else fallback to productMap
            const productName = discount.productName && discount.productName !== 'N/A' 
                ? discount.productName 
                : (discount.productId ? productMap[discount.productId] || 'N/A' : 'N/A');
            return `
                <tr>
                    <td>${discount.id}</td>
                    <td>${productName}</td>
                    <td>${discount.percent}%</td>
                    <td>${discount.startDate || 'N/A'}</td>
                    <td>${discount.endDate || 'N/A'}</td>
                    <td>
                        <button class="action-btn text-blue-600 hover:text-blue-800" onclick="editDiscount(${discount.id})"><i class="fas fa-edit"></i></button>
                        <button class="action-btn text-red-600 hover:text-red-800" onclick="deleteDiscount(${discount.id})"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `;
        }).join('') : '<tr><td colspan="6">No discounts available</td></tr>';
    } catch (error) {
        console.error('Error in populateDiscounts:', error);
        showToast('Failed to load discounts: ' + error.message, 'error');
        document.getElementById('discounts-table').innerHTML = '<tr><td colspan="6">Unable to load discounts</td></tr>';
    }
}

async function addDiscount() {
    try {
        const form = document.querySelector('#discount-form');
        const formData = new FormData(form);
        const data = {
            productId: parseInt(formData.get('productId')),
            percent: parseInt(formData.get('percent')),
            startDate: formData.get('startDate'),
            endDate: formData.get('endDate')
        };

        const response = await fetch('/api/discounts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
            credentials: 'include'
        });

        if (response.redirected && response.url.includes('/login')) {
            showToast('Session expired. Please log in.', 'error');
            window.location.href = '/login';
            return;
        }

        if (!response.ok) {
            const result = await response.json();
            throw new Error(result.error || 'Failed to add discount');
        }

        const result = await response.json();
        showToast('Discount added successfully');
        await populateDiscounts(); // Refresh table
        form.reset(); // Clear form
    } catch (error) {
        console.error('Error adding discount:', error);
        showToast(error.message, 'error');
    }
}

async function populateArtisans(data) {
    try {
        const artisans = data || await fetchData('artisans');
        const tbody = document.getElementById('artisans-table');
        tbody.innerHTML = artisans.map(artisan => `
            <tr>
                <td>${artisan.id}</td>
                <td>${artisan.name}</td>
                <td>${artisan.email}</td>
                <td>${artisan.phone_number || 'N/A'}</td>
                <td>
                    <select onchange="updateArtisanStatus(${artisan.id}, this.value)">
                        <option value="Approved" ${artisan.status === 'Approved' ? 'selected' : ''}>Approved</option>
                        <option value="Pending" ${artisan.status === 'Pending' ? 'selected' : ''}>Pending</option>
                        <option value="Suspended" ${artisan.status === 'Suspended' ? 'selected' : ''}>Suspended</option>
                    </select>
                </td>
                <td>
                    <button class="action-btn text-blue-600 hover:text-blue-800" onclick="editArtisan(${artisan.id})"><i class="fas fa-edit"></i></button>
                    <button class="action-btn text-red-600 hover:text-red-800" onclick="deleteArtisan(${artisan.id})"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
        `).join('');
    } catch (error) {
        showToast(error.message, 'error');
    }
}

async function populateStories(data) {
    try {
        const stories = data || await fetchData('stories');
        const tbody = document.getElementById('stories-table');
        tbody.innerHTML = stories.map(story => `
            <tr>
                <td>${story.id}</td>
                <td>${story.title}</td>
                <td><img src="/static/uploads/${story.image}" alt="${story.title}" class="image-preview" onerror="this.src='/static/placeholder.jpg'"></td>
                <td>
                    <button class="action-btn text-blue-600 hover:text-blue-800" onclick="editStory(${story.id})"><i class="fas fa-edit"></i></button>
                    <button class="action-btn text-red-600 hover:text-red-800" onclick="deleteStory(${story.id})"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
        `).join('');
    } catch (error) {
        showToast(error.message, 'error');
    }
}

async function populateReviews(data) {
    try {
        const reviews = data || await fetchData('reviews');
        const tbody = document.getElementById('reviews-table');
        tbody.innerHTML = reviews.map(review => `
            <tr>
                <td>${review.id}</td>
                <td>${review.product}</td>
                <td>${review.customer}</td>
                <td>${review.rating} ★</td>
                <td>
                    <select onchange="updateReviewStatus(${review.id}, this.value)">
                        <option value="Approved" ${review.status === 'Approved' ? 'selected' : ''}>Approved</option>
                        <option value="Pending" ${review.status === 'Pending' ? 'selected' : ''}>Pending</option>
                        <option value="Rejected" ${review.status === 'Rejected' ? 'selected' : ''}>Rejected</option>
                    </select>
                </td>
                <td>
                    <button class="action-btn text-blue-600 hover:text-blue-800" onclick="viewReview(${review.id})"><i class="fas fa-eye"></i></button>
                    <button class="action-btn text-red-600 hover:text-red-800" onclick="deleteReview(${review.id})"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
        `).join('');
    } catch (error) {
        showToast(error.message, 'error');
    }
}

// Form Handlers
document.getElementById('user-form').addEventListener('submit', async e => {
    e.preventDefault();
    const id = document.getElementById('user-id').value;
    const user = {
        username: document.getElementById('user-username').value.trim(),
        name: document.getElementById('user-name').value.trim(),
        email: document.getElementById('user-email').value.trim(),
        phone_number: document.getElementById('user-phone').value.trim(),
        role: document.getElementById('user-role').value
    };
    try {
        const method = id ? 'PUT' : 'POST';
        const url = id ? `/api/users/${id}` : '/api/users';
        const response = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(user)
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Operation failed');
        showToast(id ? 'User updated successfully' : 'User added successfully');
        await populateUsers();
        closeModal('user-modal');
    } catch (error) {
        showToast(error.message, 'error');
    }
});

// Product Form Submission
document.getElementById('product-form').addEventListener('submit', async e => {
    e.preventDefault();
    const id = document.getElementById('product-id').value;
    const imageInput = document.getElementById('product-image');
    
    // Validate image if provided
    if (!id && !imageInput.files[0]) {
        showToast('Image is required for new products', 'error');
        return;
    }
    if (imageInput.files[0] && !validateAndPreviewImage(imageInput, 'product-image-preview')) {
        return;
    }

    try {
        // Prepare product data
        const productData = {
            title: document.getElementById('product-name').value.trim(),
            category_id: parseInt(document.getElementById('product-category').value),
            subcategory_id: document.getElementById('product-subcategory').value ? parseInt(document.getElementById('product-subcategory').value) : null,
            price: parseFloat(document.getElementById('product-price').value),
            description: document.getElementById('product-description').value.trim() || null
        };

        // Handle image as base64
        if (imageInput.files[0]) {
            const file = imageInput.files[0];
            const base64Image = await new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(file);
            });
            productData.image = base64Image;
            productData.image_type = file.type.split('/')[1];
        }

        const method = id ? 'PUT' : 'POST';
        const url = id ? `/api/discounted_artefacts/${id}` : '/api/discounted_artefacts';
        const response = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(productData),
            credentials: 'include'
        });

        if (response.redirected && response.url.includes('/login')) {
            showToast('Session expired. Please log in.', 'error');
            window.location.href = '/login';
            return;
        }

        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Failed to save product');

        showToast(id ? 'Product updated successfully' : 'Product added successfully');
        await populateProducts();
        closeModal('product-modal');
    } catch (error) {
        showToast('Failed to save product: ' + error.message, 'error');
        console.error('Error saving product:', error);
    }
});

// Category Form Submission
document.getElementById('category-form').addEventListener('submit', async e => {
    e.preventDefault();
    const id = document.getElementById('category-id').value;
    const form = document.getElementById('category-form');
    const formData = new FormData(form);
    const imageInput = document.getElementById('category-image');
    if (!id && !imageInput.files[0]) {
        showToast('Image is required for new categories', 'error');
        return;
    }
    if (imageInput.files[0] && !validateAndPreviewImage(imageInput, 'category-image-preview')) {
        return;
    }
    try {
        const method = id ? 'PUT' : 'POST';
        const url = id ? `/api/categories/${id}` : '/api/categories';
        const response = await fetch(url, {
            method,
            body: formData,
            credentials: 'include'
        });
        if (response.redirected && response.url.includes('/login')) {
            showToast('Session expired. Please log in.', 'error');
            window.location.href = '/login';
            return;
        }
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Operation failed');
        showToast(id ? 'Category updated successfully' : 'Category added successfully');
        await populateCategories();
        closeModal('category-modal');
    } catch (error) {
        showToast(error.message, 'error');
    }
});

// Category Image Preview
document.getElementById('category-image').addEventListener('change', e => {
    validateAndPreviewImage(e.target, 'category-image-preview');
});

document.getElementById('discount-form').addEventListener('submit', async e => {
    e.preventDefault();
    const id = document.getElementById('discount-id').value;
    const productId = parseInt(document.getElementById('discount-product').value);
    const percent = parseInt(document.getElementById('discount-percent').value);
    const startDate = document.getElementById('discount-start').value;
    const endDate = document.getElementById('discount-end').value;

    // Client-side validation
    if (!productId) {
        showToast('Please select a product', 'error');
        return;
    }
    if (!percent || percent < 0 || percent > 100) {
        showToast('Discount percent must be between 0 and 100', 'error');
        return;
    }
    if (!startDate || !endDate) {
        showToast('Please provide start and end dates', 'error');
        return;
    }
    if (new Date(startDate) > new Date(endDate)) {
        showToast('End date must be after start date', 'error');
        return;
    }

    const discount = {
        productId,
        percent,
        startDate,
        endDate
    };
    try {
        const method = id ? 'PUT' : 'POST';
        const url = id ? `/api/discounts/${id}` : '/api/discounts';
        const response = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(discount)
        });

        if (response.redirected && response.url.includes('/login')) {
            showToast('Session expired. Please log in.', 'error');
            window.location.href = '/login';
            return;
        }

        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            console.error('Non-JSON response:', text.slice(0, 100));
            throw new Error('Unexpected server response');
        }

        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Operation failed');

        showToast(id ? 'Discount updated successfully' : 'Discount added successfully');
        try {
            await populateDiscounts(); // Refresh discounts table
            await populateProducts(); // Refresh products table
        } catch (refreshError) {
            console.error('Error refreshing tables:', refreshError);
            showToast('Failed to refresh tables', 'error');
        }
        closeModal('discount-modal'); // Ensure modal closes
    } catch (error) {
        console.error('Error adding/updating discount:', error);
        showToast(error.message, 'error');
        closeModal('discount-modal'); // Close modal even on error
    }
});

document.getElementById('artisan-form').addEventListener('submit', async e => {
    e.preventDefault();
    const id = document.getElementById('artisan-id').value;
    const artisan = {
        name: document.getElementById('artisan-name').value.trim(),
        email: document.getElementById('artisan-email').value.trim(),
        phone_number: document.getElementById('artisan-phone').value.trim(),
        status: document.getElementById('artisan-status').value
    };
    try {
        const method = id ? 'PUT' : 'POST';
        const url = id ? `/api/artisans/${id}` : '/api/artisans';
        const response = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(artisan)
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Operation failed');
        showToast(id ? 'Artisan updated successfully' : 'Artisan added successfully');
        await populateArtisans();
        closeModal('artisan-modal');
    } catch (error) {
        showToast(error.message, 'error');
    }
});

document.getElementById('admin-story-form').addEventListener('submit', async e => {
    e.preventDefault();
    const id = document.getElementById('admin-story-id').value;
    const formData = new FormData();
    formData.append('title', document.getElementById('admin-story-title').value.trim());
    formData.append('content', document.getElementById('admin-story-content').value.trim());
    const imageInput = document.getElementById('admin-story-image');
    if (!id && !imageInput.files[0]) {
        showToast('Image is required for new stories', 'error');
        return;
    }
    if (imageInput.files[0] && !validateAndPreviewImage(imageInput, 'admin-story-image-preview')) {
        return;
    }
    if (imageInput.files[0]) {
        formData.append('image', imageInput.files[0]);
    }
    try {
        const method = id ? 'PUT' : 'POST';
        const url = id ? `/api/stories/${id}` : '/api/stories';
        const response = await fetch(url, {
            method,
            body: formData
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Operation failed');
        showToast(id ? 'Story updated successfully' : 'Story added successfully');
        await populateStories();
        closeModal('admin-story-modal');
    } catch (error) {
        showToast(error.message, 'error');
    }
});

document.getElementById('password-form').addEventListener('submit', async e => {
    e.preventDefault();
    const currentPassword = document.getElementById('current-password').value;
    const newPassword = document.getElementById('new-password').value;
    const confirmPassword = document.getElementById('confirm-password').value;
    if (newPassword !== confirmPassword) {
        showToast('New password and confirm password do not match', 'error');
        return;
    }
    try {
        const response = await fetch('/api/change_admin_password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ current_password: currentPassword, new_password: newPassword })
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Password change failed');
        showToast('Password updated successfully');
        document.getElementById('password-form').reset();
    } catch (error) {
        showToast(error.message, 'error');
    }
});

// Edit/Delete Functions
async function editUser(id) {
    try {
        const response = await fetch(`/api/users/${id}`);
        const user = await response.json();
        if (!response.ok) throw new Error(user.error || 'Failed to fetch user');
        document.getElementById('user-id').value = user.id;
        document.getElementById('user-username').value = user.username;
        document.getElementById('user-name').value = user.name;
        document.getElementById('user-email').value = user.email;
        document.getElementById('user-phone').value = user.phone_number || '';
        document.getElementById('user-role').value = user.role;
        document.getElementById('user-modal-title').textContent = 'Edit User';
        openModal('user-modal');
    } catch (error) {
        showToast(error.message, 'error');
    }
}

async function deleteUser(id) {
    if (confirm('Are you sure you want to delete this user?')) {
        try {
            const response = await fetch(`/api/users/${id}`, { method: 'DELETE' });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Delete failed');
            showToast('User deleted successfully');
            await populateUsers();
        } catch (error) {
            showToast(error.message, 'error');
        }
    }
}

async function editProduct(id) {
    try {
        const response = await fetch(`/api/discounted_artefacts/${id}`, { credentials: 'include' });
        if (response.redirected && response.url.includes('/login')) {
            showToast('Session expired. Please log in.', 'error');
            window.location.href = '/login';
            return;
        }
        const product = await response.json();
        if (!response.ok) throw new Error(product.error || 'Failed to fetch product');
        document.getElementById('product-id').value = product.id;
        document.getElementById('product-name').value = product.name || product.title;
        document.getElementById('product-category').value = product.category_id;
        document.getElementById('product-subcategory').value = product.subcategory_id || '';
        document.getElementById('product-price').value = product.price;
        document.getElementById('product-description').value = product.description || '';
        const preview = document.getElementById('product-image-preview');
        if (product.image) {
            preview.src = `/static/uploads/${product.image}`;
            preview.classList.remove('hidden');
        } else {
            preview.src = '';
            preview.classList.add('hidden');
        }
        document.getElementById('product-modal-title').textContent = 'Edit Product';
        openModal('product-modal');
    } catch (error) {
        showToast(error.message, 'error');
    }
}

async function deleteProduct(id) {
    if (confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
        try {
            const response = await fetch(`/api/discounted_artefacts/${id}`, { 
                method: 'DELETE',
                credentials: 'include'  
            });
            
            if (response.redirected && response.url.includes('/login')) {
                showToast('Session expired. Please log in.', 'error');
                window.location.href = '/login';
                return;
            }
            
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Delete failed');
            
            showToast('Product deleted successfully');
            await populateProducts();
            await populateDiscounts();
            
        } catch (error) {
            showToast(error.message, 'error');
            console.error('Error deleting product:', error);
        }
    }
}

// Edit Category
async function editCategory(id) {
    try {
        const response = await fetch(`/api/categories/${id}`, { credentials: 'include' });
        if (response.redirected && response.url.includes('/login')) {
            showToast('Session expired. Please log in.', 'error');
            window.location.href = '/login';
            return;
        }
        const category = await response.json();
        if (!response.ok) throw new Error(category.error || 'Failed to fetch category');
        document.getElementById('category-id').value = category.id;
        document.getElementById('category-name').value = category.name;
        document.getElementById('category-description').value = category.description || '';
        const preview = document.getElementById('category-image-preview');
        if (category.image) {
            preview.src = `/static/uploads/${category.image}`;
            preview.classList.remove('hidden');
        } else {
            preview.classList.add('hidden');
            preview.src = '';
        }
        document.getElementById('category-modal-title').textContent = 'Edit Category';
        openModal('category-modal');
    } catch (error) {
        showToast('Failed to edit category: ' + error.message, 'error');
    }
}


// Delete Category (Ensure proper DELETE request)
async function deleteCategory(id) {
    if (confirm('Are you sure you want to delete this category?')) {
        try {
            const response = await fetch(`/api/categories/${id}`, {
                method: 'DELETE',
                credentials: 'include'
            });
            if (response.redirected && response.url.includes('/login')) {
                showToast('Session expired. Please log in.', 'error');
                window.location.href = '/login';
                return;
            }
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Delete failed');
            showToast('Category deleted successfully');
            await populateCategories();
        } catch (error) {
            showToast('Failed to delete category: ' + error.message, 'error');
        }
    }
}

async function editDiscount(id) {
    try {
        const response = await fetch(`/api/discounts/${id}`, { credentials: 'include' });
        if (response.redirected && response.url.includes('/login')) {
            showToast('Session expired. Please log in.', 'error');
            window.location.href = '/login';
            return;
        }
        const discount = await response.json();
        if (!response.ok) throw new Error(discount.error || 'Failed to fetch discount');
        document.getElementById('discount-id').value = discount.id;
        document.getElementById('discount-product').value = discount.productId || '';
        document.getElementById('discount-percent').value = discount.percent;
        document.getElementById('discount-start').value = discount.startDate;
        document.getElementById('discount-end').value = discount.endDate;
        document.getElementById('discount-modal-title').textContent = 'Edit Discount';
        openModal('discount-modal');
    } catch (error) {
        console.error('Error in editDiscount:', error);
        showToast(error.message, 'error');
    }
}

async function deleteDiscount(id) {
    if (confirm('Are you sure you want to delete this discount?')) {
        try {
            const response = await fetch(`/api/discounts/${id}`, { method: 'DELETE' });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Delete failed');
            showToast('Discount deleted successfully');
            await populateDiscounts();
            await populateProducts();
        } catch (error) {
            showToast(error.message, 'error');
        }
    }
}

async function editArtisan(id) {
    try {
        const response = await fetch(`/api/artisans/${id}`);
        const artisan = await response.json();
        if (!response.ok) throw new Error(artisan.error || 'Failed to fetch artisan');
        document.getElementById('artisan-id').value = artisan.id;
        document.getElementById('artisan-name').value = artisan.name;
        document.getElementById('artisan-email').value = artisan.email;
        document.getElementById('artisan-phone').value = artisan.phone_number || '';
        document.getElementById('artisan-status').value = artisan.status;
        document.getElementById('artisan-modal-title').textContent = 'Edit Artisan Seller';
        openModal('artisan-modal');
    } catch (error) {
        showToast(error.message, 'error');
    }
}

async function deleteArtisan(id) {
    if (confirm('Are you sure you want to delete this artisan?')) {
        try {
            const response = await fetch(`/api/artisans/${id}`, { method: 'DELETE' });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Delete failed');
            showToast('Artisan deleted successfully');
            await populateArtisans();
        } catch (error) {
            showToast(error.message, 'error');
        }
    }
}

async function editStory(id) {
    try {
        const response = await fetch(`/api/stories/${id}`);
        const story = await response.json();
        if (!response.ok) throw new Error(story.error || 'Failed to fetch story');
        document.getElementById('admin-story-id').value = story.id;
        document.getElementById('admin-story-title').value = story.title;
        document.getElementById('admin-story-content').value = story.content;
        const preview = document.getElementById('admin-story-image-preview');
        if (story.image) {
            preview.src = `/static/uploads/${story.image}`;
            preview.classList.remove('hidden');
        }
        document.getElementById('admin-story-modal-title').textContent = 'Edit Story';
        openModal('admin-story-modal');
    } catch (error) {
        showToast(error.message, 'error');
    }
}

async function deleteStory(id) {
    if (confirm('Are you sure you want to delete this story?')) {
        try {
            const response = await fetch(`/api/stories/${id}`, { method: 'DELETE' });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Delete failed');
            showToast('Story deleted successfully');
            await populateStories();
        } catch (error) {
            showToast(error.message, 'error');
        }
    }
}

async function viewOrder(orderId) {
    try {
        const response = await fetch(`/api/orders/${orderId}`, { credentials: 'include' });
        if (response.redirected && response.url.includes('/login')) {
            showToast('Session expired. Please log in.', 'error');
            window.location.href = '/login';
            return;
        }
        const order = await response.json();
        if (!response.ok) throw new Error(order.error || 'Failed to fetch order');
        const itemsList = order.items && Array.isArray(order.items) ? 
            order.items.map(item => `${item.product_name}: ${item.quantity}`).join('\n') : 
            'No items';
        const location = order.location && typeof order.location === 'object' ? 
            `${order.location.street || ''}, ${order.location.city || ''}, ${order.location.country || ''}${order.location.postal_code ? ', ' + order.location.postal_code : ''}`.trim().replace(/^,+|,+$/g, '') 
            : 'N/A';
        alert(`Order Details:\nID: ${order.id}\nCustomer: ${order.customer}\nCustomer Number: ${order.customer_number || 'N/A'}\nLocation: ${location}\nProducts:\n${itemsList}\nTotal: KSh ${order.total.toFixed(2)}\nCustomer Status: ${order.customer_status}\nStatus: ${order.status}\nPayment Method: ${order.payment_method}`);
    } catch (error) {
        showToast(error.message, 'error');
    }
}

async function updateArtisanStatus(id, status) {
    try {
        const response = await fetch(`/api/artisans/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status })
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Update failed');
        showToast('Artisan status updated');
        await populateArtisans();
    } catch (error) {
        showToast(error.message, 'error');
    }
}

async function viewReview(id) {
    try {
        const response = await fetch(`/api/reviews/${id}`);
        const review = await response.json();
        if (!response.ok) throw new Error(review.error || 'Failed to fetch review');
        alert(`Review Details:\nID: ${review.id}\nProduct: ${review.product}\nCustomer: ${review.customer}\nRating: ${review.rating} ★\nComment: ${review.comment || 'N/A'}\nStatus: ${review.status}`);
    } catch (error) {
        showToast(error.message, 'error');
    }
}

async function updateReviewStatus(id, status) {
    try {
        const response = await fetch(`/api/reviews/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status })
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Update failed');
        showToast('Review status updated');
        await populateReviews();
    } catch (error) {
        showToast(error.message, 'error');
    }
}

async function deleteReview(id) {
    if (confirm('Are you sure you want to delete this review?')) {
        try {
            const response = await fetch(`/api/reviews/${id}`, { method: 'DELETE' });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Delete failed');
            showToast('Review deleted successfully');
            await populateReviews();
        } catch (error) {
            showToast(error.message, 'error');
        }
    }
}

// Search Filters
function setupSearch(id, endpoint, tableFn) {
    document.getElementById(id).addEventListener('input', async e => {
        const query = e.target.value.toLowerCase();
        try {
            const data = await fetchData(endpoint);
            const filtered = data.filter(item => Object.values(item).some(val => val && val.toString().toLowerCase().includes(query)));
            tableFn(filtered);
        } catch (error) {
            showToast(error.message, 'error');
        }
    });
}

setupSearch('users-search', 'users', populateUsers);
setupSearch('products-search', 'discounted_artefacts', populateProducts);
setupSearch('orders-search', 'orders', populateOrders);
setupSearch('categories-search', 'categories', data => {
    const query = document.getElementById('categories-search').value.toLowerCase();
    const filtered = data.filter(category => 
        category.name.toLowerCase().includes(query) ||
        (category.description && category.description.toLowerCase().includes(query))
    );
    populateCategories(filtered);
});
setupSearch('discounts-search', 'discounts', populateDiscounts);
setupSearch('artisans-search', 'artisans', populateArtisans);
setupSearch('stories-search', 'stories', populateStories);
setupSearch('reviews-search', 'reviews', populateReviews);

// Populate Dropdowns
async function populateProductCategories() {
    try {
        const categories = await fetchData('categories');
        const select = document.getElementById('product-category');
        select.innerHTML = categories.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
    } catch (error) {
        showToast(error.message, 'error');
    }
}

async function populateDiscountProducts() {
    try {
        console.log('Populating discount products...');
        const products = await fetchData('discounted_artefacts');
        console.log('Fetched products:', products);
        const select = document.getElementById('discount-product');
        if (!select) {
            console.error('Element with ID "discount-product" not found');
            showToast('Failed to load product selector', 'error');
            return;
        }
        const productOptions = Array.isArray(products) ? products : [];
        select.innerHTML = '<option value="">Select a product</option>' + 
            productOptions.map(p => `<option value="${p.id}">${p.name || p.title || 'Unnamed Product'}</option>`).join('');
    } catch (error) {
        console.error('Error in populateDiscountProducts:', error);
        showToast(error.message, 'error');
    }
}

// Logout
async function logout() {
    try {
        const response = await fetch('/logout');
        const data = await response.json();
        showToast(data.message || 'Logged out successfully');
        setTimeout(() => {
            window.location.href = '/login';
        }, 1000);
    } catch (error) {
        showToast(error.message, 'error');
    }
}

// Populate Gifts Table
async function populateGifts(data) {
    try {
        const gifts = data || await fetchData('gifts');
        const tbody = document.getElementById('gifts-table');
        tbody.innerHTML = gifts.map(gift => `
            <tr>
                <td>${gift.id}</td>
                <td>${gift.name}</td>
                <td>KSh ${gift.price.toFixed(2)}</td>
                <td>${gift.image ? `<img src="/static/uploads/${gift.image}" alt="${gift.name}" class="image-preview" onerror="this.src='/static/placeholder.jpg'">` : 'No Image'}</td>
                <td>${gift.hero_text}</td>
                <td>${gift.start_date}</td>
                <td>${gift.end_date}</td>
                <td>
                    <button class="action-btn text-blue-600 hover:text-blue-800" onclick="editGift(${gift.id})"><i class="fas fa-edit"></i></button>
                    <button class="action-btn text-red-600 hover:text-red-800" onclick="deleteGift(${gift.id})"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
        `).join('');
    } catch (error) {
        showToast(error.message, 'error');
    }
}

// Edit Gift
async function editGift(id) {
    try {
        const response = await fetch(`/api/gifts/${id}`, { credentials: 'include' });
        if (response.redirected && response.url.includes('/login')) {
            showToast('Session expired. Please log in.', 'error');
            window.location.href = '/login';
            return;
        }
        const gift = await response.json();
        if (!response.ok) throw new Error(gift.error || 'Failed to fetch gift');
        document.getElementById('gift-id').value = gift.id;
        document.getElementById('gift-name').value = gift.name;
        document.getElementById('gift-hero-text').value = gift.hero_text;
        document.getElementById('gift-price').value = gift.price;
        document.getElementById('gift-start-date').value = gift.start_date;
        document.getElementById('gift-end-date').value = gift.end_date;
        const preview = document.getElementById('gift-image-preview');
        if (gift.image) {
            preview.src = `/static/uploads/${gift.image}`;
            preview.classList.remove('hidden');
        }
        document.getElementById('gift-modal-title').textContent = 'Edit Gift';
        openModal('gift-modal');
    } catch (error) {
        showToast(error.message, 'error');
    }
}

// Delete Gift
async function deleteGift(id) {
    if (confirm('Are you sure you want to delete this gift?')) {
        try {
            const response = await fetch(`/api/gifts/${id}`, {
                method: 'DELETE',
                credentials: 'include'
            });
            if (response.redirected && response.url.includes('/login')) {
                showToast('Session expired. Please log in.', 'error');
                window.location.href = '/login';
                return;
            }
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Delete failed');
            showToast('Gift deleted successfully');
            await populateGifts();
        } catch (error) {
            showToast(error.message, 'error');
        }
    }
}

// Gift Form Submission
document.getElementById('gift-form').addEventListener('submit', async e => {
    e.preventDefault();
    const id = document.getElementById('gift-id').value;
    const form = document.getElementById('gift-form');
    const formData = new FormData(form);
    const imageInput = document.getElementById('gift-image');
    if (!id && !imageInput.files[0]) {
        showToast('Image is required for new gifts', 'error');
        return;
    }
    if (imageInput.files[0] && !validateAndPreviewImage(imageInput, 'gift-image-preview')) {
        return;
    }
    try {
        const method = id ? 'PUT' : 'POST';
        const url = id ? `/api/gifts/${id}` : '/api/gifts';
        const response = await fetch(url, {
            method,
            body: formData,
            credentials: 'include'
        });
        if (response.redirected && response.url.includes('/login')) {
            showToast('Session expired. Please log in.', 'error');
            window.location.href = '/login';
            return;
        }
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Operation failed');
        showToast(id ? 'Gift updated successfully' : 'Gift added successfully');
        await populateGifts();
        closeModal('gift-modal');
    } catch (error) {
        showToast(error.message, 'error');
    }
});

// Gift Image Preview
document.getElementById('gift-image').addEventListener('change', e => {
    validateAndPreviewImage(e.target, 'gift-image-preview');
});

// Gift Search Filter
setupSearch('gifts-search', 'gifts', populateGifts);

// Populate Subcategories Table
async function populateSubcategories(data) {
    try {
        const subcategories = data || await fetchData('subcategories');
        const categories = await fetchData('categories');
        const categoryMap = categories.reduce((map, cat) => {
            map[cat.id] = cat.name;
            return map;
        }, {});
        const tbody = document.getElementById('subcategories-table');
        tbody.innerHTML = subcategories.map(sub => `
            <tr>
                <td>${sub.id}</td>
                <td>${sub.name}</td>
                <td>${categoryMap[sub.category_id] || 'N/A'}</td>
                <td>${sub.description || 'N/A'}</td>
                <td>
                    <button class="action-btn text-blue-600 hover:text-blue-800" onclick="editSubcategory(${sub.id})"><i class="fas fa-edit"></i></button>
                    <button class="action-btn text-red-600 hover:text-red-800" onclick="deleteSubcategory(${sub.id})"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
        `).join('');
    } catch (error) {
        showToast('Failed to load subcategories: ' + error.message, 'error');
    }
}


// Edit Subcategory
async function editSubcategory(id) {
    try {
        const response = await fetch(`/api/subcategories/${id}`, { credentials: 'include' });
        if (response.redirected && response.url.includes('/login')) {
            showToast('Session expired. Please log in.', 'error');
            window.location.href = '/login';
            return;
        }
        const sub = await response.json();
        if (!response.ok) throw new Error(sub.error || 'Failed to fetch subcategory');
        document.getElementById('subcategory-id').value = sub.id;
        document.getElementById('subcategory-name').value = sub.name;
        document.getElementById('subcategory-description').value = sub.description || '';
        document.getElementById('subcategory-category').value = sub.category_id;
        document.getElementById('subcategory-modal-title').textContent = 'Edit Subcategory';
        openModal('subcategory-modal');
    } catch (error) {
        showToast(error.message, 'error');
    }
}

// Delete Subcategory
async function deleteSubcategory(id) {
    if (confirm('Are you sure you want to delete this subcategory?')) {
        try {
            const response = await fetch(`/api/subcategories/${id}`, {
                method: 'DELETE',
                credentials: 'include'
            });
            if (response.redirected && response.url.includes('/login')) {
                showToast('Session expired. Please log in.', 'error');
                window.location.href = '/login';
                return;
            }
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Delete failed');
            showToast('Subcategory deleted successfully');
            await populateSubcategories();
        } catch (error) {
            showToast(error.message, 'error');
        }
    }
}

// Subcategory Form Submission
document.getElementById('subcategory-form').addEventListener('submit', async e => {
    e.preventDefault();
    const id = document.getElementById('subcategory-id').value;
    const data = {
        name: document.getElementById('subcategory-name').value.trim(),
        description: document.getElementById('subcategory-description').value.trim(),
        category_id: parseInt(document.getElementById('subcategory-category').value)
    };
    try {
        const method = id ? 'PUT' : 'POST';
        const url = id ? `/api/subcategories/${id}` : '/api/subcategories';
        const response = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
            credentials: 'include'
        });
        if (response.redirected && response.url.includes('/login')) {
            showToast('Session expired. Please log in.', 'error');
            window.location.href = '/login';
            return;
        }
        const result = await response.json();
        if (!response.ok) throw new Error(result.error || 'Operation failed');
        showToast(id ? 'Subcategory updated successfully' : 'Subcategory added successfully');
        await populateSubcategories();
        closeModal('subcategory-modal');
    } catch (error) {
        showToast(error.message, 'error');
    }
});

// Populate Subcategory Dropdowns
async function populateSubcategoriesForDropdown(selectId, categoryId) {
    try {
        const subcategories = await fetchData('subcategories');
        const select = document.getElementById(selectId);
        const filtered = subcategories.filter(sub => sub.category_id == categoryId);
        select.innerHTML = '<option value="">None</option>' + filtered.map(sub => `<option value="${sub.id}">${sub.name}</option>`).join('');
    } catch (error) {
        showToast('Failed to load subcategories: ' + error.message, 'error');
    }
}

// Update Gift Table Population
async function populateGifts(data) {
    try {
        const gifts = data || await fetchData('gifts');
        const tbody = document.getElementById('gifts-table');
        tbody.innerHTML = gifts.map(gift => `
            <tr>
                <td>${gift.id}</td>
                <td>${gift.product_name}</td>
                <td>${gift.category || 'N/A'}</td>
                <td>${gift.subcategory || 'None'}</td>
                <td>KSh ${gift.price.toFixed(2)}</td>
                <td>${gift.image ? `<img src="/static/uploads/${gift.image}" alt="${gift.product_name}" class="image-preview" onerror="this.src='/static/placeholder.jpg'">` : 'No Image'}</td>
                <td>${gift.description}</td>
                <td>${gift.start_date}</td>
                <td>${gift.end_date}</td>
                <td>
                    <button class="action-btn text-blue-600 hover:text-blue-800" onclick="editGift(${gift.id})"><i class="fas fa-edit"></i></button>
                    <button class="action-btn text-red-600 hover:text-red-800" onclick="deleteGift(${gift.id})"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
        `).join('');
    } catch (error) {
        showToast(error.message, 'error');
    }
}

// Update Edit Gift
async function editGift(id) {
    try {
        const response = await fetch(`/api/gifts/${id}`, { credentials: 'include' });
        if (response.redirected && response.url.includes('/login')) {
            showToast('Session expired. Please log in.', 'error');
            window.location.href = '/login';
            return;
        }
        const gift = await response.json();
        if (!response.ok) throw new Error(gift.error || 'Failed to fetch gift');
        document.getElementById('gift-id').value = gift.id;
        document.getElementById('gift-product-name').value = gift.product_name;
        document.getElementById('gift-description').value = gift.description;
        document.getElementById('gift-price').value = gift.price;
        document.getElementById('gift-start-date').value = gift.start_date;
        document.getElementById('gift-end-date').value = gift.end_date;
        document.getElementById('gift-category').value = gift.category_id;
        await populateSubcategoriesForDropdown('gift-subcategory', gift.category_id);
        document.getElementById('gift-subcategory').value = gift.subcategory_id || '';
        const preview = document.getElementById('gift-image-preview');
        if (gift.image) {
            preview.src = `/static/uploads/${gift.image}`;
            preview.classList.remove('hidden');
        }
        document.getElementById('gift-modal-title').textContent = 'Edit Gift';
        openModal('gift-modal');
    } catch (error) {
        showToast(error.message, 'error');
    }
}

// Update Product Categories and Subcategories
async function populateProductCategories() {
    try {
        const categories = await fetchData('categories');
        const select = document.getElementById('product-category');
        select.innerHTML = categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        // Populate subcategories for the first category
        if (categories.length > 0) {
            await populateSubcategoriesForDropdown('product-subcategory', categories[0].id);
        }
    } catch (error) {
        showToast(error.message, 'error');
    }
}

// Populate Subcategory Category Dropdown
async function populateSubcategoryCategories() {
    try {
        const categories = await fetchData('categories');
        const select = document.getElementById('subcategory-category');
        select.innerHTML = categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    } catch (error) {
        showToast(error.message, 'error');
    }
}

// Populate Gift Categories
async function populateGiftCategories() {
    try {
        const categories = await fetchData('categories');
        const select = document.getElementById('gift-category');
        select.innerHTML = categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        // Populate subcategories for the first category
        if (categories.length > 0) {
            await populateSubcategoriesForDropdown('gift-subcategory', categories[0].id);
        }
    } catch (error) {
        showToast(error.message, 'error');
    }
}

// Category Change Handlers
document.getElementById('product-category').addEventListener('change', e => {
    populateSubcategoriesForDropdown('product-subcategory', e.target.value);
});

document.getElementById('gift-category').addEventListener('change', e => {
    populateSubcategoriesForDropdown('gift-subcategory', e.target.value);
});

// Subcategory Search Filter
setupSearch('subcategories-search', 'subcategories', populateSubcategories);

// Initialize
// Initialize (Ensure all tables are populated)
async function initialize() {
    try {
        const sessionResponse = await fetch('/api/check_session', { credentials: 'include' });
        if (sessionResponse.redirected || !sessionResponse.ok) {
            showToast('Please log in to access the admin portal', 'error');
            window.location.href = '/login';
            return;
        }
        await fetchDashboardStats();
        await Promise.all([
            populateUsers(),
            populateProducts(),
            populateOrders(),
            populateCategories(),
            populateSubcategories(),
            populateDiscounts(),
            populateArtisans(),
            populateStories(),
            populateReviews(),
            populateGifts()
        ]);
        startPolling();
        pollOrders();
        initializeManualOrderModal();
    } catch (error) {
        showToast('Initialization failed: ' + error.message, 'error');
        window.location.href = '/login';
    }
}
// Call initialization on page load
document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>