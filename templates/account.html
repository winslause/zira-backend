<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zira Artifacts - My Account</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/logo.png') }}">
    <!-- Custom Styles -->
    <style>
        /* Custom Font */
        body, .navbar {
            font-family: 'Poppins', sans-serif;
        }

        /* Animations */
        .animate-fadeIn { animation: fadeIn 0.8s ease-out forwards; }
        .animate-slideIn { animation: slideIn 0.6s ease-out forwards; }
        .animate-bounceIn { animation: bounceIn 1s ease-out forwards; }
        .animate-zoomIn { animation: zoomIn 5s ease-out forwards; }
        .animate-pageLoad { animation: pageLoad 1s ease-out forwards; }
        .animate-navLoad { animation: navLoad 0.8s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.95); }
            50% { opacity: 0.5; transform: scale(1.05); }
            100% { opacity: 1; transform: scale(1); }
        }
        @keyframes zoomIn {
            from { background-size: 100%; }
            to { background-size: 110%; }
        }
        @keyframes pageLoad {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes navLoad {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Toggler Animations */
        .animate-rotateToggle {
            animation: rotateToggle 0.3s ease-in-out forwards;
        }
        .animate-bounce {
            animation: bounce 0.2s ease-in-out;
        }
        .animate-pulse {
            animation: pulse 0.3s ease-in-out;
        }
        @keyframes rotateToggle {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(90deg) scale(1.2); }
            100% { transform: rotate(180deg) scale(1); }
        }
        @keyframes bounce {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Delay Classes */
        .delay-\[100ms\] { animation-delay: 100ms; }
        .delay-\[200ms\] { animation-delay: 200ms; }
        .delay-\[300ms\] { animation-delay: 300ms; }

        /* Navbar Styling */
        .navbar {
            background: #ffffff; /* Tailwind white */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 1rem 0;
            position: fixed;
            width: 100%;
            z-index: 50;
            animation: navLoad 0.8s ease-out;
        }
        .navbar-item {
            position: relative;
            font-size: 1.2rem;
            font-weight: 500;
            color: #4b5563; /* Tailwind gray-700 */
            padding: 0.75rem 1.5rem;
            transition: all 0.3s ease;
            border-radius: 8px;
        }
        .navbar-item:hover, .navbar-item.active {
            color: #1f2937; /* Tailwind gray-900 */
            transform: scale(1.05);
            background-color: rgba(0, 0, 0, 0.05);
        }
        .navbar-item::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 3px;
            background-color: #1f2937;
            transition: width 0.3s ease;
        }
        .navbar-item:hover::after, .navbar-item.active::after {
            width: 50%;
        }
        .nav-hover:hover {
            transform: scale(1.05);
        }

        /* Search Container */
        .search-container {
            position: relative;
        }
        .search-container input {
            border: 1px solid #d1d5db; /* Tailwind gray-300 */
            border-radius: 0.375rem;
            padding: 0.5rem 2.5rem 0.5rem 0.75rem;
            outline: none;
        }
        .search-container .fa-search {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280; /* Tailwind gray-500 */
        }
        #mobile-search-bar {
            display: none;
            position: absolute;
            top: 3rem;
            left: 0;
            right: 0;
            margin: 0 1rem;
            z-index: 45;
        }
        #mobile-search-bar.active {
            display: block;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 50;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal.open {
            display: flex;
            opacity: 1;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            transform: translateY(-50px);
            transition: transform 0.3s ease;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        .modal.open .modal-content {
            transform: translateY(0);
        }
        .modal-close {
            position: absolute;
            top: 12px;
            right: 12px;
            color: #6b7280;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        .modal-close:hover {
            color: #d97706;
        }

        /* Card Styles */
        .custom-card {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 2px solid transparent;
            background-clip: padding-box;
        }
        .custom-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
            border-color: #d97706;
        }

        /* Profile Card */
        .profile-card {
            background: linear-gradient(145deg, #ffffff, #f9fafb);
            border: 2px solid transparent;
            border-image: linear-gradient(to right, #d97706, #facc15) 1;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }
        .profile-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
        }
        .profile-pic-container {
            position: relative;
            overflow: hidden;
            border-radius: 50%;
            border: 4px solid #d97706;
            transition: transform 0.3s ease, border-color 0.3s ease;
        }
        .profile-pic-container:hover {
            transform: scale(1.1);
            border-color: #facc15;
        }
        .profile-pic-container img {
            object-fit: cover;
            width: 100%;
            height: 100%;
        }

        /* Wishlist and Cart Cards */
        .wishlist-card, .cart-card {
            border: 2px solid #e5e7eb;
        }
        .wishlist-card:hover, .cart-card:hover {
            border-color: #d97706;
        }
        .wishlist-card img, .cart-card img {
            border-radius: 8px;
            transition: transform 0.3s ease;
        }
        .wishlist-card:hover img, .cart-card:hover img {
            transform: scale(1.05);
        }
        .action-btn {
            transition: background-color 0.3s ease, transform 0.3s ease;
        }
        .action-btn:hover {
            transform: scale(1.05);
        }

        /* Total Card */
        .total-card {
            background: linear-gradient(145deg, #fef3c7, #fef9c3);
            border: 2px solid #d97706;
        }

        /* Radio Button Styles */
        .radio-group {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .radio-group input[type="radio"] {
            accent-color: #d97706;
        }

        /* Search Bar Styling */
        .search-input:focus {
            border-color: #d97706;
            box-shadow: 0 0 0 3px rgba(217, 119, 6, 0.2);
        }

        /* Mobile Sidebar Styling */
        .mobile-sidebar-item {
            display: block;
            padding: 0.75rem 1rem;
            font-size: 1.1rem;
            font-weight: 500;
            color: #4b5563;
            transition: color 0.3s ease, background-color 0.3s ease;
        }
        .mobile-sidebar-item:hover, .mobile-sidebar-item.active {
            color: #d97706;
            background-color: #f3f4f6;
        }

        /* Responsive Adjustments */
        @media (max-width: 767px) {
            .grid-cols-1-2 {
                grid-template-columns: 1fr;
            }
            .modal-content {
                width: 95%;
                padding: 1.5rem;
            }
            .profile-pic-container {
                width: 100px !important;
                height: 100px !important;
            }
            .wishlist-card, .cart-card {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            .wishlist-card img, .cart-card img {
                width: 120px !important;
                height: 120px !important;
            }
            .radio-group {
                flex-direction: column;
                align-items: flex-start;
            }
            .navbar {
                padding: 0.5rem 0;
            }
            .navbar-logo {
                height: 48px;
            }
        }
        @media (min-width: 768px) and (max-width: 1023px) {
            .grid-cols-1-2 {
                grid-template-columns: 1fr;
            }
            .navbar-item {
                padding: 0.5rem 0.75rem;
                font-size: 1rem;
            }
            .navbar-logo {
                height: 56px;
            }
        }
        @media (min-width: 1024px) {
            .navbar-logo {
                height: 64px;
            }
        }

        /* Checkout Modal Specific Styles */
       /* Checkout Modal Specific Styles */
#checkout-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    overflow-y: auto;
    z-index: 9999;
    display: none;
    align-items: flex-start; /* Align to top on mobile */
    justify-content: center;
    padding-top: 1rem;
}

#checkout-modal.open {
    display: flex;
}

.modal-content {
    max-height: 80vh;
    overflow-y: auto;
    margin: 1rem auto;
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    width: 95%;
    max-width: 500px;
    position: relative;
    z-index: 10; /* Consistent z-index for modal content */
}

#checkout-modal .custom-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    z-index: 10; /* Match modal content to avoid stacking issues */
}

@media (max-width: 767px) {
    #checkout-modal {
        padding-top: 0.5rem;
    }

    .modal-content {
        margin: 0.5rem auto;
        padding: 1rem;
        max-height: 70vh;
    }

    #checkout-modal .custom-card {
        margin-top: 1rem;
        width: 95%;
        max-width: none;
        position: relative; /* Stack below modal content */
    }
}

@media (min-width: 768px) {
    #checkout-modal {
        align-items: center;
        padding: 2rem;
    }

    #checkout-modal > div {
        display: flex;
        flex-direction: row;
        align-items: flex-start;
        gap: 2rem; /* Space between modal content and payment card */
        max-width: 1000px; /* Wider container to accommodate both */
    }

    .modal-content {
        margin: 0;
        padding: 2rem;
        max-height: 90vh;
        width: 500px; /* Fixed width for consistency */
        max-width: none;
    }

    #checkout-modal .custom-card {
        position: relative; /* Use flexbox positioning instead of absolute */
        width: 340px;
        margin-top: 0;
        flex-shrink: 0; /* Prevent card from shrinking */
    }
}





        /* Password Toggle Icon */
.password-toggle {
    position: absolute;
    right: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    color: #6b7280; /* Tailwind gray-500 */
    transition: color 0.3s ease;
}
.password-toggle:hover {
    color: #d97706; /* Tailwind yellow-600 */
}
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <!-- Navbar -->
    <nav class="navbar bg-white shadow-md fixed w-full z-50">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <!-- Mobile Navbar -->
            <div class="md:hidden flex items-center justify-between w-full relative">
                <button id="nav-toggler" class="text-2xl"><i class="fas fa-bars"></i></button>
                <img loading="lazy" src="{{ url_for('static', filename='images/logo.png') }}" alt="Zira Artifacts Logo" class="h-12 navbar-logo">
                <div class="flex items-center space-x-4">
                    <i id="mobile-search-icon" class="fas fa-search text-gray-700 hover:text-gray-900 cursor-pointer"></i>
                    <a href="{{ url_for('account') }}" class="fas fa-shopping-cart text-gray-700 hover:text-gray-900"></a>
                </div>
                <!-- Mobile Search Bar -->
                <div id="mobile-search-bar" class="bg-white shadow-md rounded px-3 py-1 hidden">
                    <input type="text" placeholder="Search artifacts & cultural items" class="w-full outline-none text-gray-700 search-input">
                </div>
            </div>
            <!-- Desktop Navbar -->
            <div class="hidden md:flex items-center justify-between w-full">
                <img loading="lazy" src="{{ url_for('static', filename='images/logo.png') }}" alt="Zira Artifacts Logo" class="h-12 navbar-logo">
                <div class="flex space-x-6">
                    <div class="relative nav-hover">
                        <a href="{{ url_for('index') }}" class="navbar-item text-gray-700">Home</a>
                    </div>
                    <div class="relative nav-hover">
                        <a href="{{ url_for('our_products') }}" class="navbar-item text-gray-700">Products</a>
                    </div>
                    <div class="relative nav-hover">
                        <a href="{{ url_for('discounted_artefacts') }}" class="navbar-item text-gray-700">Special Discount</a>
                    </div>
                </div>
                <!-- Search and Icons -->
                <div class="flex items-center space-x-4">
                    <div class="search-container">
                        <input type="text" placeholder="Search artifacts & cultural items" class="border rounded px-3 py-1 search-input">
                        <i class="fas fa-search"></i>
                    </div>
                    <a href="{{ url_for('account') }}" class="fas fa-heart text-gray-700 hover:text-gray-900"></a>
                    <a href="{{ url_for('account') }}" class="fas fa-shopping-cart text-gray-700 hover:text-gray-900"></a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mobile Sidebar -->
    <div id="mobile-sidebar" class="fixed inset-y-0 left-0 w-64 bg-white shadow-lg transform -translate-x-full transition-transform z-30">
        <div class="p-4">
            <button id="close-sidebar" class="text-2xl mb-4"><i class="fas fa-times"></i></button>
            <div class="space-y-2" style="padding-top: 20px;">
                <a href="{{ url_for('index') }}" class="mobile-sidebar-item">Home</a>
                <a href="{{ url_for('our_products') }}" class="mobile-sidebar-item">Products</a>
                <a href="{{ url_for('discounted_artefacts') }}" class="mobile-sidebar-item">Special Discount</a>
                <a href="{{ url_for('user_login') }}" class="mobile-sidebar-item">Login</a>
                <a href="{{ url_for('account') }}" class="mobile-sidebar-item active">My Account</a>
                <a href="{{ url_for('user_logout') }}" class="mobile-sidebar-item">Logout</a>
            </div>
        </div>
    </div>

    <!-- Hero Section -->
    <section class="relative h-72 bg-cover bg-center animate-zoomIn" style="background-image: url('{{ url_for('static', filename='images/pot1.jpg') }}');">
        <div class="absolute inset-0 bg-black bg-opacity-60 flex items-center justify-center">
            <h1 class="text-4xl md:text-5xl font-bold text-white animate-fadeIn">My Account</h1>
        </div>
    </section>

    <!-- Profile Section -->
    <section class="py-20 bg-gray-100">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 lg:grid-cols-1-2 gap-8">
                <!-- Profile Info -->
                <div class="custom-card profile-card p-8 animate-slideIn delay-[100ms]">
                    <div class="flex flex-col sm:flex-row items-center gap-6 mb-8">
                        <div class="profile-pic-container w-32 h-32">
                            <img loading="lazy" src="{{ url_for('static', filename='uploads/' ~ user.profile_picture) if user.profile_picture else 'https://via.placeholder.com/150' }}" alt="Profile Picture" id="profile-pic" class="object-cover w-full h-full">
                        </div>
                        <div class="text-center sm:text-left">
                            <h2 class="text-3xl font-bold text-gray-800">{{ user.name }}</h2>
                            <p class="text-gray-600 text-lg">{{ user.email }}</p>
                            <p class="text-gray-600 text-lg">{{ user.phone_number or 'No phone number' }}</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <button class="action-btn bg-yellow-600 text-white px-6 py-3 rounded-lg hover:bg-yellow-700 text-lg font-medium" onclick="openModal('profile-modal')">Update Profile</button>
                        <button class="action-btn bg-yellow-600 text-white px-6 py-3 rounded-lg hover:bg-yellow-700 text-lg font-medium" onclick="openModal('picture-modal')">Change Picture</button>
                        <button class="action-btn bg-yellow-600 text-white px-6 py-3 rounded-lg hover:bg-yellow-700 text-lg font-medium" onclick="openModal('address-modal')">Add Address</button>
                        <button class="action-btn bg-yellow-600 text-white px-6 py-3 rounded-lg hover:bg-yellow-700 text-lg font-medium" id="change-password-btn" onclick="openModal('password-modal')">Change Password</button>
                        <a href="{{ url_for('user_logout') }}" class="action-btn bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 text-lg font-medium text-center">Logout</a>
                    </div>
                </div>

                <!-- Wishlist, Cart, and Orders -->
                <div class="space-y-8 animate-slideIn delay-[200ms]">
                    <!-- Wishlist -->
                    <div class="custom-card p-6">
                        <h3 class="text-2xl font-semibold text-gray-800 mb-4">Wishlist</h3>
                        <div id="wishlist-items" class="space-y-4">
    {% for item in wishlist_items %}
        {% if item.product %}
            <div class="wishlist-card flex flex-col sm:flex-row items-center gap-4 p-6 custom-card" data-wishlist-id="{{ item.id }}">
                <img loading="lazy" src="{{ url_for('static', filename='uploads/' + item.product.image) | default('https://via.placeholder.com/120x120') }}" alt="{{ item.product.name }}" class="w-24 h-24 object-cover">
                <div class="flex-1 text-center sm:text-left">
                    <h3 class="text-xl font-semibold text-gray-800">{{ item.product.name }}</h3>
                    {% if item.product.discount and item.product.discount.percent > 0 %}
                        <p class="text-gray-600 price text-lg" data-price="{{ item.product.price }}" data-discounted-price="{{ (item.product.price * (1 - item.product.discount.percent / 100)) | round(2) }}" data-has-discount="true">{{ current_currency }} {{ (item.product.price * (1 - item.product.discount.percent / 100)) | round(2) }}</p>
                        <p class="text-gray-500 line-through text-sm" data-original-price="{{ item.product.price }}">{{ current_currency }} {{ item.product.price }}</p>
                    {% else %}
                        <p class="text-gray-600 price text-lg" data-price="{{ item.product.price }}" data-has-discount="false">{{ current_currency }} {{ item.product.price }}</p>
                    {% endif %}
                </div>
                <div class="flex gap-3">
                    <button class="text-red-500 hover:text-red-700" onclick="removeFromWishlist({{ item.id }})"><i class="fas fa-trash text-lg"></i></button>
                    <button class="action-btn bg-yellow-600 text-white px-3 py-2 rounded-lg hover:bg-yellow-700" onclick="addToCartFromWishlist({{ item.id }}, {{ item.product.id }})"><i class="fas fa-cart-plus text-lg"></i></button>
                </div>
            </div>
        {% else %}
            <div class="wishlist-card flex items-center gap-4 p-6 custom-card">
                <p class="text-gray-600">Product not found (ID: {{ item.product_id }})</p>
                <button class="text-red-500 hover:text-red-700" onclick="removeFromWishlist({{ item.id }})"><i class="fas fa-trash text-lg"></i></button>
            </div>
        {% endif %}
    {% else %}
        <div class="custom-card p-6">
            <p class="text-gray-600 text-lg">Your wishlist is empty.</p>
        </div>
    {% endfor %}
</div>
                    </div>

                    <!-- Cart -->
                    <div class="custom-card p-6">
                        <h3 class="text-2xl font-semibold text-gray-800 mb-4">Cart</h3>
                        <div id="cart-items" class="space-y-4">
                            {% for item in cart_items %}
    <div class="cart-card flex flex-col sm:flex-row items-center gap-4 p-6 custom-card" data-product-id="{{ item.product_id }}">
        <img loading="lazy" src="{{ url_for('static', filename='uploads/' + item.product.image) | default('https://via.placeholder.com/120x120') }}" alt="{{ item.product.name }}" class="w-24 h-24 object-cover">
        <div class="flex-1 text-center sm:text-left">
            <h3 class="text-xl font-semibold text-gray-800">{{ item.product.name }}</h3>
            {% if item.product.discount and item.product.discount.percent > 0 %}
                <p class="text-gray-600 price text-lg" data-price="{{ item.product.price }}" data-discounted-price="{{ (item.product.price * (1 - item.product.discount.percent / 100)) | round(2) }}">{{ current_currency }} {{ (item.product.price * (1 - item.product.discount.percent / 100)) | round(2) }}</p>
                <p class="text-gray-500 line-through text-sm" data-original-price="{{ item.product.price }}">{{ current_currency }} {{ item.product.price }}</p>
            {% else %}
                <p class="text-gray-600 price text-lg" data-price="{{ item.product.price }}">{{ current_currency }} {{ item.product.price }}</p>
            {% endif %}
            <div class="flex items-center justify-center sm:justify-start gap-2 mt-2">
                <button class="action-btn bg-gray-300 text-gray-800 px-2 py-1 rounded hover:bg-gray-400" onclick="updateCartQuantity({{ item.product_id }}, {{ item.quantity - 1 }})"><i class="fas fa-minus"></i></button>
                <input type="number" class="w-16 p-1 border rounded text-center" value="{{ item.quantity }}" min="1" onchange="updateCartQuantity({{ item.product_id }}, this.value)">
                <button class="action-btn bg-gray-300 text-gray-800 px-2 py-1 rounded hover:bg-gray-400" onclick="updateCartQuantity({{ item.product_id }}, {{ item.quantity + 1 }})"><i class="fas fa-plus"></i></button>
            </div>
        </div>
        <button class="text-red-500 hover:text-red-700" onclick="removeFromCart({{ item.product_id }})"><i class="fas fa-trash text-lg"></i></button>
    </div>
{% else %}
    <div class="custom-card p-6">
        <p class="text-gray-600 text-lg">Your cart is empty.</p>
    </div>
{% endfor %}                        </div>
                        <div class="total-card mt-6 p-6 flex flex-col sm:flex-row justify-between items-center gap-4">
                            <p class="text-xl font-semibold text-gray-800">Total: <span id="cart-total">{{ current_currency }} 0.00</span></p>
                            <button onclick="openModal('checkout-modal')" class="action-btn bg-yellow-600 text-white px-6 py-3 rounded-lg hover:bg-yellow-700 text-lg font-medium">Proceed to Checkout</button>
                        </div>
                    </div>

                    <!-- Orders -->
                    <div class="custom-card p-6">
                        <h3 class="text-2xl font-semibold text-gray-800 mb-4">My Orders</h3>
<div id="order-items" class="space-y-4">
    {% for order in orders %}
        <div class="order-card flex flex-col gap-4 p-6 custom-card">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <h3 class="text-xl font-semibold text-gray-800">Order #{{ order.id }}</h3>
                    <p class="text-gray-600 text-lg">Date: {{ order.created_at.strftime('%Y-%m-%d') }}</p>
                    <p class="text-gray-600 text-lg">Total: <span class="price" data-price="{{ order.total }}">{{ current_currency }} {{ order.total }}</span></p>
                    <p class="text-gray-600 text-lg">Status: {{ order.status }}</p>
                </div>
                {% if order.status == 'Pending' %}
                    <button class="action-btn bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700" onclick="cancelOrder({{ order.id }})">Cancel Order</button>
                {% endif %}
            </div>
            <div class="border-t pt-4">
                <h4 class="text-lg font-semibold text-gray-800 mb-2">Items</h4>
                {% for item in order.order_items %}
                    <div class="flex flex-col sm:flex-row items-center gap-4 mb-2">
                        {% if item.product %}
                            <img loading="lazy" src="{{ url_for('static', filename='uploads/' + item.product.image) | default('https://via.placeholder.com/80x80') }}" alt="{{ item.product.name }}" class="w-20 h-20 object-cover rounded">
                            <div class="flex-1">
                                <p class="text-gray-800 font-medium">{{ item.product.name }}</p>
                                <p class="text-gray-600">Quantity: {{ item.quantity }}</p>
                                
                            </div>
                        {% else %}
                            <div class="flex-1">
                                <p class="text-gray-600">Product not found (ID: {{ item.product_id }})</p>
                                <p class="text-gray-600">Quantity: {{ item.quantity }}</p>
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
    {% else %}
        <div class="custom-card p-6">
            <p class="text-gray-600 text-lg">You have no orders.</p>
        </div>
    {% endfor %}
</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Modals -->
    <!-- Update Profile Modal -->
    <div id="profile-modal" class="modal">
        <div class="modal-content relative">
            <span class="modal-close" onclick="closeModal('profile-modal')"><i class="fas fa-times"></i></span>
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Update Profile</h2>
            <form id="profile-form" class="space-y-4" onsubmit="updateProfile(event)">
                <div>
                    <label class="block text-gray-700 mb-1">Full Name</label>
                    <input type="text" name="name" value="{{ user.name }}" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-yellow-600">
                </div>
                <div>
                    <label class="block text-gray-700 mb-1">Email</label>
                    <input type="email" name="email" value="{{ user.email }}" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-yellow-600">
                </div>
                <div>
                    <label class="block text-gray-700 mb-1">Phone Number</label>
                    <input type="tel" name="phone_number" value="{{ user.phone_number | default('') }}" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-yellow-600">
                </div>
                <button type="submit" class="action-btn bg-yellow-600 text-white px-4 py-2 rounded w-full hover:bg-yellow-700">Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Change Profile Picture Modal -->
    <div id="picture-modal" class="modal">
        <div class="modal-content relative">
            <span class="modal-close" onclick="closeModal('picture-modal')"><i class="fas fa-times"></i></span>
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Change Profile Picture</h2>
            <form id="picture-form" class="space-y-4" enctype="multipart/form-data">
                <div>
                    <label class="block text-gray-700 mb-1">Upload Image</label>
                    <input type="file" accept="image/*" name="image" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-yellow-600">
                </div>
                <button type="submit" class="action-btn bg-yellow-600 text-white px-4 py-2 rounded w-full hover:bg-yellow-700">Upload Picture</button>
            </form>
        </div>
    </div>

    <!-- Add Address Modal -->
    <div id="address-modal" class="modal">
        <div class="modal-content relative">
            <span class="modal-close" onclick="closeModal('address-modal')"><i class="fas fa-times"></i></span>
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Add Address</h2>
            <form id="address-form" class="space-y-4">
                <div>
                    <label class="block text-gray-700 mb-1">Street Address</label>
                    <input type="text" name="street" value="{{ address.street | default('') }}" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-yellow-600">
                </div>
                <div>
                    <label class="block text-gray-700 mb-1">City</label>
                    <input type="text" name="city" value="{{ address.city | default('') }}" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-yellow-600">
                </div>
                <div>
                    <label class="block text-gray-700 mb-1">Country</label>
                    <select name="country" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-yellow-600">
                        <option value="Kenya" {{ 'selected' if address.country == 'Kenya' }}>Kenya</option>
                        <option value="USA" {{ 'selected' if address.country == 'USA' }}>USA</option>
                        <option value="Germany" {{ 'selected' if address.country == 'Germany' }}>Germany</option>
                        <option value="UK" {{ 'selected' if address.country == 'UK' }}>UK</option>
                        
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 mb-1">Postal Code</label>
                    <input type="text" name="postal_code" value="{{ address.postal_code | default('') }}" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-yellow-600">
                </div>
                <button type="submit" class="action-btn bg-yellow-600 text-white px-4 py-2 rounded w-full hover:bg-yellow-700">Save Address</button>
            </form>
        </div>
    </div>

   <!-- Checkout Modal -->
<div id="checkout-modal" class="modal">
    <div class="relative flex flex-col items-center justify-center max-w-5xl mx-auto p-4">
        <!-- Modal Content -->
        <div class="modal-content relative bg-white rounded-lg p-6 w-full max-w-lg animate-slideIn delay-[200ms] z-10">
            <span class="modal-close" onclick="closeModal('checkout-modal')"><i class="fas fa-times"></i></span>
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Checkout</h2>
            <form id="checkout-form" class="space-y-4" onsubmit="placeOrder(event)">
                <div>
                    <label class="block text-gray-700 mb-1">Full Name</label>
                    <input type="text" name="name" value="{{ user.name }}" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-yellow-600" required>
                </div>
                <div>
                    <label class="block text-gray-700 mb-1">Phone Number</label>
                    <input type="tel" name="phone_number" value="{{ user.phone_number | default('') }}" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-yellow-600" required>
                </div>
                <div>
                    <label class="block text-gray-700 mb-1">Street Address</label>
                    <input type="text" name="street" value="{{ address.street | default('') }}" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-yellow-600" required>
                </div>
                <div>
                    <label class="block text-gray-700 mb-1">City</label>
                    <input type="text" name="city" value="{{ address.city | default('') }}" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-yellow-600" required>
                </div>
                <div>
                    <label class="block text-gray-700 mb-1">Country</label>
                    <select name="country" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-yellow-600" required>
                        <option value="USA" {{ 'selected' if address.country == 'USA' }}>USA</option>
                        <option value="Germany" {{ 'selected' if address.country == 'Germany' }}>Germany</option>
                        <option value="UK" {{ 'selected' if address.country == 'UK' }}>UK</option>
                        <option value="Kenya" {{ 'selected' if address.country == 'Kenya' }}>Kenya</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 mb-1">Postal Code</label>
                    <input type="text" name="postal_code" value="{{ address.postal_code | default('') }}" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-yellow-600" required>
                </div>
                <div>
                    <label class="block text-gray-700 mb-1">Payment Method</label>
                    <div class="radio-group">
                        <label class="flex items-center">
                            <input type="radio" name="payment_method" value="immediate" class="mr-2" onchange="toggleMessageCode(); updatePaymentDetails();" disabled checked>
                            Pay Immediately
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="payment_method" value="delivery" class="mr-2" onchange="toggleMessageCode(); updatePaymentDetails();" >
                            Pay on Delivery
                        </label>
                    </div>
                </div>
                <div id="message-code-section">
                    <label class="block text-gray-700 mb-1">Message Code</label>
                    <input type="text" name="message_code" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-yellow-600" disabled>
                </div>
                <div class="flex gap-4">
                    <button type="submit" class="action-btn bg-yellow-600 text-white px-4 py-2 rounded flex-1 hover:bg-yellow-700">Place Order</button>
                    <button type="button" class="action-btn bg-gray-500 text-white px-4 py-2 rounded flex-1 hover:bg-gray-600" onclick="closeModal('checkout-modal')">Cancel</button>
                </div>
            </form>
        </div>
        <!-- Floating Payment Details Card -->
        <div class="custom-card p-6 bg-white rounded-lg shadow-lg w-full max-w-md mt-4 animate-slideIn delay-[100ms] md:absolute md:top-4 md:right-4 md:w-80 md:mt-0">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Payment Details(Currently not available. Only pay on Delivery at the moment)</h3>
            <div id="payment-details" class="space-y-4">
                <!-- Default content for Pay Immediately -->
                <div id="immediate-payment-details">
                    <div class="mb-4">
                        <h4 class="text-lg font-medium text-gray-700">contact us</h4>
                        <p class="text-gray-600 text-sm">Email: <a href="mailto:payments@ziraartifacts.com" class="text-yellow-600 hover:underline">payments@ziraartifacts.com</a></p>
                        <p class="text-gray-600 text-sm mt-1">Thank you</p>
                    </div>
                    <div>
                        <h4 class="text-lg font-medium text-gray-700">Bank Transfer</h4>
                        <p class="text-gray-600 text-sm">Bank: Zira Bank</p>
                        <p class="text-gray-600 text-sm">Account: </p>
                        <p class="text-gray-600 text-sm">SWIFT: </p>
                        <p class="text-gray-600 text-sm mt-1">Reference:</p>
                    </div>
                </div>
                <!-- Content for Pay on Delivery (hidden by default) -->
                <div id="delivery-payment-details" class="hidden">
                    <p class="text-gray-600 text-sm">Payment will be collected upon delivery.</p>
                    <p class="text-gray-600 text-sm mt-1">Please ensure you have cash or a valid payment method available when your order arrives.</p>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- Floating Country Button -->
    <div id="country-btn-container" class="fixed bottom-16 left-16 z-20">
        <button id="country-btn" class="bg-yellow-600 text-white px-4 py-2 rounded-full shadow-lg hover:bg-yellow-700 transition flex items-center">
            <span class="flag">🇺🇸</span> USA
        </button>
        <div id="country-dropdown" class="hidden absolute bottom-14 left-0 bg-white shadow-md rounded-md p-4 w-32">
            <a href="#" class="block py-1 hover:text-gray-900 country-option" data-country="USA" data-currency="USD" data-flag="🇺🇸"><span class="text-sm mr-2">🇺🇸</span>USA</a>
            <a href="#" class="block py-1 hover:text-gray-900 country-option" data-country="Germany" data-currency="EUR" data-flag="🇩🇪"><span class="text-sm mr-2">🇩🇪</span>Germany</a>
            <a href="#" class="block py-1 hover:text-gray-900 country-option" data-country="UK" data-currency="GBP" data-flag="🇬🇧"><span class="text-sm mr-2">🇬🇧</span>UK</a>
            <a href="#" class="block py-1 hover:text-gray-900 country-option" data-country="Kenya" data-currency="KES" data-flag="🇰🇪"><span class="text-sm mr-2">🇰🇪</span>Kenya</a>
        </div>
    </div>

 
<!-- Change Password Modal -->
<div id="password-modal" class="modal">
    <div class="modal-content relative">
        <span class="modal-close" onclick="closeModal('password-modal')"><i class="fas fa-times"></i></span>
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Change Password</h2>
        <form id="password-form" class="space-y-4" onsubmit="changePassword(event)">
            <div class="relative">
                <label class="block text-gray-700 mb-1">Old Password</label>
                <input type="password" name="old_password" id="old-password" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-yellow-600" required autocomplete="current-password">
                <i class="fas fa-eye password-toggle" onclick="togglePassword('old-password')"></i>
            </div>
            <div class="relative">
                <label class="block text-gray-700 mb-1">New Password</label>
                <input type="password" name="new_password" id="new-password" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-yellow-600" required autocomplete="new-password">
                <i class="fas fa-eye password-toggle" onclick="togglePassword('new-password')"></i>
            </div>
            <div class="relative">
                <label class="block text-gray-700 mb-1">Confirm New Password</label>
                <input type="password" name="confirm_password" id="confirm-password" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-yellow-600" required autocomplete="new-password">
                <i class="fas fa-eye password-toggle" onclick="togglePassword('confirm-password')"></i>
            </div>
            <button type="submit" id="change-password-submit" class="action-btn bg-yellow-600 text-white px-4 py-2 rounded w-full hover:bg-yellow-700">Change Password</button>
        </form>
    </div>
</div>


   <!-- Footer -->
<footer class="bg-black text-white py-12 px-6">
    <div class="max-w-7xl mx-auto">
        <!-- Desktop Layout -->
        <div class="hidden md:grid grid-cols-5 gap-8 text-sm">
            <!-- Shop -->
            <div>
                <h3 class="text-yellow-600 font-semibold mb-3">Shop</h3>
                <ul class="space-y-2">
                    <li><a href="{{ url_for('our_products') }}" class="text-white hover:text-yellow-400">Artifact Collections</a></li>
                    <li><a href="{{ url_for('account') }}" class="text-white hover:text-yellow-400">Track My Order</a></li>
                </ul>
            </div>
            <!-- Sell -->
            <div>
                <h3 class="text-yellow-600 font-semibold mb-3">Sell</h3>
                <ul class="space-y-2">
                    <li><a href="#" class="text-white hover:text-yellow-400">Sell on Zira Artifacts</a></li>
                    <li><a href="#" class="text-white hover:text-yellow-400">Artisan Seller FAQ</a></li>
                </ul>
            </div>
            <!-- Policies -->
            <div>
                <h3 class="text-yellow-600 font-semibold mb-3">Policies</h3>
                <ul class="space-y-2">
                    <li><a href="#" class="text-white hover:text-yellow-400">Return & Refund Policy</a></li>
                    <li><a href="#" class="text-white hover:text-yellow-400">Privacy & Sharing</a></li>
                </ul>
            </div>
            <!-- Company -->
            <div>
                <h3 class="text-yellow-600 font-semibold mb-3">Company</h3>
                <ul class="space-y-2">
                    <li><a href="{{ url_for('index') }}" class="text-white hover:text-yellow-400">About Us</a></li>
                    <li><a href="{{ url_for('index') }}" class="text-white hover:text-yellow-400">Contact Us</a></li>
                    <li><a href="{{ url_for('login') }}" class="text-white hover:text-yellow-400">Admin</a></li>
                    <li class="mt-4 text-white font-medium">+254 790 867 733</li>
                    <li>sales@ziraartifacts.com</li>
                    <li class="flex gap-4 mt-2 text-xl">
                        <a href="#"><i class="fab fa-pinterest"></i></a>
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-youtube"></i></a>
                        <a href="#"><i class="fab fa-whatsapp"></i></a>
                    </li>
                </ul>
            </div>
            <!-- Subscribe -->
            <div>
                <h3 class="text-yellow-600 font-semibold mb-3">Let’s Get in Touch</h3>
                <p class="text-sm mb-3">Sign up to subscribe and receive 5% off your artifact order</p>
                <form class="flex items-center border rounded-md overflow-hidden bg-white text-black">
                    <input type="email" placeholder="Enter your email" class="px-3 py-2 w-full focus:outline-none">
                    <button type="submit" class="px-3 py-2 text-white bg-yellow-600 hover:bg-yellow-700 transition"><i class="fas fa-arrow-right"></i></button>
                </form>
                <div class="mt-2 flex items-start gap-2">
                    <input type="checkbox" class="mt-1">
                    <p class="text-xs">I agree with the <a href="#" class="underline">Terms & Conditions</a></p>
                </div>
            </div>
        </div>
        <!-- Mobile Dropdowns -->
        <div class="md:hidden space-y-4">
            <!-- Shop -->
            <details class="bg-gray-900 rounded-md p-4">
                <summary class="text-yellow-500 font-semibold cursor-pointer">Shop</summary>
                <ul class="grid grid-cols-2 gap-x-4 gap-y-2 mt-3 text-sm">
                    <li><a href="{{ url_for('our_products') }}" class="text-white hover:text-yellow-400">Artifact Collections</a></li>
                    <li><a href="{{ url_for('account') }}" class="text-white hover:text-yellow-400">Track My Order</a></li>
                </ul>
            </details>
            <!-- Sell -->
            <details class="bg-gray-900 rounded-md p-4">
                <summary class="text-yellow-500 font-semibold cursor-pointer">Sell</summary>
                <ul class="grid grid-cols-2 gap-x-4 gap-y-2 mt-3 text-sm">
                    <li><a href="#" class="text-white hover:text-yellow-400">Sell on Zira Artifacts</a></li>
                    <li><a href="#" class="text-white hover:text-yellow-400">Artisan Seller FAQ</a></li>
                </ul>
            </details>
            <!-- Policies -->
            <details class="bg-gray-900 rounded-md p-4">
                <summary class="text-yellow-500 font-semibold cursor-pointer">Policies</summary>
                <ul class="grid grid-cols-2 gap-x-4 gap-y-2 mt-3 text-sm">
                    <li><a href="#" class="text-white hover:text-yellow-400">Return & Refund Policy</a></li>
                    <li><a href="#" class="text-white hover:text-yellow-400">Privacy & Sharing</a></li>
                </ul>
            </details>
            <!-- Company -->
            <details class="bg-gray-900 rounded-md p-4">
                <summary class="text-yellow-500 font-semibold cursor-pointer">Company</summary>
                <ul class="grid grid-cols-2 gap-x-4 gap-y-2 mt-3 text-sm">
                    <li><a href="{{ url_for('index') }}" class="text-white hover:text-yellow-400">About Us</a></li>
                    <li><a href="{{ url_for('index') }}" class="text-white hover:text-yellow-400">Contact Us</a></li>
                    <li><a href="{{ url_for('login') }}" class="text-white hover:text-yellow-400">Admin</a></li>
                </ul>
                <div class="mt-3 text-sm">
                    <p>+254 790 867 733</p>
                    <p>sales@ziraartifacts.com</p>
                    <div class="flex gap-3 mt-2 text-xl">
                        <a href="#"><i class="fab fa-pinterest"></i></a>
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-youtube"></i></a>
                        <a href="#"><i class="fab fa-whatsapp"></i></a>
                    </div>
                </div>
            </details>
            <!-- Subscribe -->
            <details class="bg-gray-900 rounded-md p-4">
                <summary class="text-yellow-500 font-semibold cursor-pointer">Let’s Get in Touch</summary>
                <p class="text-sm mt-2">Sign up to subscribe and receive 5% off your artifact order</p>
                <form class="flex items-center border rounded-md overflow-hidden bg-white text-black mt-2">
                    <input type="email" placeholder="Enter your email" class="px-3 py-2 w-full focus:outline-none">
                    <button type="submit" class="px-3 py-2 text-white bg-yellow-600 hover:bg-yellow-700 transition"><i class="fas fa-arrow-right"></i></button>
                </form>
                <div class="mt-2 flex items-start gap-2">
                    <input type="checkbox" class="mt-1">
                    <p class="text-xs">I agree with the <a href="#" class="underline">Terms & Conditions</a></p>
                </div>
            </details>
        </div>
    </div>
</footer>
    <!-- JavaScript -->
  
<script>
// Currency Conversion Logic (KES as base currency)
const exchangeRates = {
    USD: 0.0077, // 1 KES = 0.0077 USD (1 USD ≈ 130 KES)
    EUR: 0.0073, // 1 KES = 0.0073 EUR
    GBP: 0.0061, // 1 KES = 0.0061 GBP
    KES: 1       // 1 KES = 1 KES
};
let currentCurrency = '{{ current_currency | safe }}';

// Helper Function to Format Dates Safely
function formatDate(dateString) {
    console.log(`Formatting date: ${dateString}`);
    if (!dateString) {
        console.warn(`Invalid date string: ${dateString}`);
        return 'Unknown date';
    }
    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) {
            console.warn(`Invalid date value: ${dateString}`);
            return 'Unknown date';
        }
        return date.toISOString().split('T')[0];
    } catch (error) {
        console.warn(`Error parsing date ${dateString}: ${error.message}`);
        return 'Unknown date';
    }
}

// Toggle Country Dropdown
document.getElementById('country-btn')?.addEventListener('click', () => {
    console.log('Toggling country dropdown');
    const dropdown = document.getElementById('country-dropdown');
    if (dropdown) {
        dropdown.classList.toggle('hidden');
    } else {
        console.error('Country dropdown not found');
    }
});

// Update Currency
document.querySelectorAll('.country-option').forEach(option => {
    option.addEventListener('click', (e) => {
        console.log('Currency option clicked');
        e.preventDefault();
        const country = e.target.getAttribute('data-country');
        const flag = e.target.getAttribute('data-flag');
        currentCurrency = e.target.getAttribute('data-currency');
        const countryBtn = document.getElementById('country-btn');
        if (countryBtn) {
            countryBtn.innerHTML = `<span class="flag">${flag}</span> ${country}`;
        }
        const dropdown = document.getElementById('country-dropdown');
        if (dropdown) {
            dropdown.classList.add('hidden');
        }
        updatePrices();
    });
});

// Update Wishlist, Cart, and Order Prices
function updatePrices() {
    console.log('Updating prices for currency:', currentCurrency);
    let cartTotal = 0;
    
    // Update Wishlist Prices
    document.querySelectorAll('#wishlist-items .price').forEach(priceElement => {
        const hasDiscount = priceElement.getAttribute('data-has-discount') === 'true';
        const basePriceKES = parseFloat(priceElement.getAttribute('data-discounted-price') || priceElement.getAttribute('data-price'));
        
        if (isNaN(basePriceKES)) {
            console.error('Invalid base price for wishlist item:', priceElement, 'data-price:', priceElement.getAttribute('data-price'), 'data-discounted-price:', priceElement.getAttribute('data-discounted-price'));
            priceElement.textContent = `${currentCurrency} N/A`;
            return;
        }
        
        const convertedPrice = (basePriceKES * exchangeRates[currentCurrency]).toFixed(2);
        priceElement.textContent = `${currentCurrency} ${convertedPrice}`;
        console.log(`Wishlist item - Has discount: ${hasDiscount}, Base price (KES): ${basePriceKES}, Converted price: ${currentCurrency} ${convertedPrice}`);
        
        const originalPriceElement = priceElement.parentElement.querySelector('[data-original-price]');
        if (originalPriceElement) {
            const originalPriceKES = parseFloat(originalPriceElement.getAttribute('data-original-price'));
            if (isNaN(originalPriceKES)) {
                console.error('Invalid original price for wishlist item:', originalPriceElement, 'data-original-price:', originalPriceElement.getAttribute('data-original-price'));
                originalPriceElement.textContent = `${currentCurrency} N/A`;
            } else {
                const convertedOriginalPrice = (originalPriceKES * exchangeRates[currentCurrency]).toFixed(2);
                originalPriceElement.textContent = `${currentCurrency} ${convertedOriginalPrice}`;
                console.log(`Wishlist item - Original price (KES): ${originalPriceKES}, Converted original price: ${currentCurrency} ${convertedOriginalPrice}`);
            }
        }
    });
    
    // Update Cart Prices and Total
    document.querySelectorAll('#cart-items .price').forEach(priceElement => {
        const hasDiscount = priceElement.getAttribute('data-has-discount') === 'true';
        const basePriceKES = parseFloat(priceElement.getAttribute('data-discounted-price') || priceElement.getAttribute('data-price'));
        const quantityElement = priceElement.parentElement.querySelector('input[type="number"]');
        const quantity = quantityElement ? parseInt(quantityElement.value) : 1;
        
        if (isNaN(basePriceKES)) {
            console.error('Invalid base price for cart item:', priceElement, 'data-price:', priceElement.getAttribute('data-price'), 'data-discounted-price:', priceElement.getAttribute('data-discounted-price'));
            priceElement.textContent = `${currentCurrency} N/A`;
            return;
        }
        
        const convertedPrice = (basePriceKES * exchangeRates[currentCurrency]).toFixed(2);
        priceElement.textContent = `${currentCurrency} ${convertedPrice}`;
        cartTotal += basePriceKES * quantity;
        console.log(`Cart item - Has discount: ${hasDiscount}, Base price (KES): ${basePriceKES}, Converted price: ${currentCurrency} ${convertedPrice}`);
        
        const originalPriceElement = priceElement.parentElement.querySelector('[data-original-price]');
        if (originalPriceElement) {
            const originalPriceKES = parseFloat(originalPriceElement.getAttribute('data-original-price'));
            if (isNaN(originalPriceKES)) {
                console.error('Invalid original price for cart item:', originalPriceElement, 'data-original-price:', originalPriceElement.getAttribute('data-original-price'));
                originalPriceElement.textContent = `${currentCurrency} N/A`;
            } else {
                const convertedOriginalPrice = (originalPriceKES * exchangeRates[currentCurrency]).toFixed(2);
                originalPriceElement.textContent = `${currentCurrency} ${convertedOriginalPrice}`;
                console.log(`Cart item - Original price (KES): ${originalPriceKES}, Converted original price: ${currentCurrency} ${convertedOriginalPrice}`);
            }
        }
    });
    
    // Update Order Prices
    document.querySelectorAll('#order-items .price').forEach(priceElement => {
        const hasDiscount = priceElement.getAttribute('data-has-discount') === 'true';
        const basePriceKES = parseFloat(
            hasDiscount 
                ? priceElement.getAttribute('data-discounted-price') 
                : priceElement.getAttribute('data-price')
        );
        
        if (isNaN(basePriceKES)) {
            console.error('Invalid base price for order item:', priceElement, 'data-price:', priceElement.getAttribute('data-price'), 'data-discounted-price:', priceElement.getAttribute('data-discounted-price'));
            priceElement.textContent = `${currentCurrency} N/A`;
            return;
        }
        
        const convertedPrice = (basePriceKES * exchangeRates[currentCurrency]).toFixed(2);
        priceElement.textContent = `${currentCurrency} ${convertedPrice}`;
        console.log(`Order item - Has discount: ${hasDiscount}, Base price (KES): ${basePriceKES}, Converted price: ${currentCurrency} ${convertedPrice}`);
        
        // Update original price if it exists
        const originalPriceElement = priceElement.parentElement.querySelector('[data-original-price]');
        if (originalPriceElement) {
            const originalPriceKES = parseFloat(originalPriceElement.getAttribute('data-original-price'));
            if (isNaN(originalPriceKES)) {
                console.error('Invalid original price for order item:', originalPriceElement, 'data-original-price:', originalPriceElement.getAttribute('data-original-price'));
                originalPriceElement.textContent = `${currentCurrency} N/A`;
            } else {
                const convertedOriginalPrice = (originalPriceKES * exchangeRates[currentCurrency]).toFixed(2);
                originalPriceElement.textContent = `${currentCurrency} ${convertedOriginalPrice}`;
                console.log(`Order item - Original price (KES): ${originalPriceKES}, Converted original price: ${currentCurrency} ${convertedOriginalPrice}`);
            }
        }
    });
    
    // Update Order Totals
    document.querySelectorAll('#order-items .price[data-price]').forEach(totalElement => {
        const baseTotalKES = parseFloat(totalElement.getAttribute('data-price'));
        if (isNaN(baseTotalKES)) {
            console.error('Invalid base total for order:', totalElement, 'data-price:', totalElement.getAttribute('data-price'));
            totalElement.textContent = `${currentCurrency} N/A`;
        } else {
            const convertedTotal = (baseTotalKES * exchangeRates[currentCurrency]).toFixed(2);
            totalElement.textContent = `${currentCurrency} ${convertedTotal}`;
            console.log(`Order total - Base total (KES): ${baseTotalKES}, Converted total: ${currentCurrency} ${convertedTotal}`);
        }
    });
    
    // Update Cart Total
    const cartTotalElement = document.getElementById('cart-total');
    if (cartTotalElement) {
        cartTotalElement.textContent = `${currentCurrency} ${(cartTotal * exchangeRates[currentCurrency]).toFixed(2)}`;
    }
}

// Modal Functions
function openModal(modalId) {
    console.log(`Attempting to open modal: ${modalId}`);
    const modal = document.getElementById(modalId);
    if (!modal) {
        console.error(`Modal ${modalId} not found`);
        showToast(`Modal ${modalId} not found`, 'error');
        return;
    }
    modal.classList.add('open');
    document.body.style.overflow = 'hidden';
    console.log(`Modal ${modalId} opened successfully`);
}

function closeModal(modalId) {
    console.log(`Attempting to close modal: ${modalId}`);
    const modal = document.getElementById(modalId);
    if (!modal) {
        console.error(`Modal ${modalId} not found`);
        return;
    }
    modal.classList.remove('open');
    document.body.style.overflow = 'auto';
    console.log(`Modal ${modalId} closed successfully`);
}

// Update Profile
function updateProfile(event) {
    event.preventDefault();
    console.log('Updating profile');
    const form = event.target;
    const data = {
        name: form.name.value,
        email: form.email.value,
        phone_number: form.phone_number.value
    };
    fetch('/api/users/{{ user.id }}', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
        credentials: 'include'
    })
    .then(response => response.json().then(data => ({ status: response.status, body: data })))
    .then(({ status, body }) => {
        if (status >= 400) {
            throw new Error(body.error || 'Failed to update profile');
        }
        showToast(body.message || 'User updated successfully', 'success');
        closeModal('profile-modal');
        setTimeout(() => {
            console.log('Reloading page after profile update');
            location.reload();
        }, 3000);
    })
    .catch(error => {
        console.error('Error updating profile:', error);
        showToast('Failed to update profile: ' + error.message, 'error');
        if (error.message.includes('Unauthorized')) {
            window.location.href = '{{ url_for('user_login') }}';
        }
    });
}

// Change Profile Picture
document.getElementById('picture-form')?.addEventListener('submit', (e) => {
    e.preventDefault();
    console.log('Submitting profile picture');
    const fileInput = e.target.querySelector('input[type="file"]');
    if (fileInput.files[0]) {
        const formData = new FormData();
        formData.append('image', fileInput.files[0]);
        fetch('/api/profile/picture', {
            method: 'POST',
            body: formData,
            credentials: 'include'
        })
        .then(response => response.json().then(data => ({ status: response.status, body: data })))
        .then(({ status, body }) => {
            if (status >= 400) {
                throw new Error(body.error || 'Failed to update profile picture');
            }
            if (body.image_url) {
                document.getElementById('profile-pic').src = body.image_url;
                showToast('Profile picture updated!', 'success');
            } else {
                showToast('Failed to update profile picture', 'error');
            }
            closeModal('picture-modal');
        })
        .catch(error => {
            console.error('Error uploading picture:', error);
            showToast('Failed to upload picture: ' + error.message, 'error');
            if (error.message.includes('Unauthorized')) {
                window.location.href = '{{ url_for('user_login') }}';
            }
        });
    }
});

// Add Address
document.getElementById('address-form')?.addEventListener('submit', (e) => {
    e.preventDefault();
    console.log('Adding address');
    fetch('/api/profile/address', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            street: e.target.street.value,
            city: e.target.city.value,
            country: e.target.country.value,
            postal_code: e.target.postal_code.value,
        }),
        credentials: 'include'
    })
    .then(response => response.json().then(data => ({ status: response.status, body: data })))
    .then(({ status, body }) => {
        if (status >= 400) {
            throw new Error(body.error || 'Failed to add address');
        }
        showToast(body.message || 'Address added successfully', 'success');
        closeModal('address-modal');
        setTimeout(() => {
            console.log('Reloading page after adding address');
            location.reload();
        }, 3000);
    })
    .catch(error => {
        console.error('Error adding address:', error);
        showToast('Failed to add address: ' + error.message, 'error');
        if (error.message.includes('Unauthorized')) {
            window.location.href = '{{ url_for('user_login') }}';
        }
    });
});

// Remove from Wishlist
function removeFromWishlist(wishlistId) {
    console.log(`Removing wishlist item: ${wishlistId}`);
    fetch(`/api/wishlist/${wishlistId}`, {
        method: 'DELETE',
        credentials: 'include'
    })
    .then(response => response.json().then(data => ({ status: response.status, body: data })))
    .then(({ status, body }) => {
        if (status >= 400) {
            throw new Error(body.error || 'Failed to remove from wishlist');
        }
        showToast(body.message || 'Removed from wishlist', 'success');
        setTimeout(() => {
            console.log('Reloading page after removing from wishlist');
            location.reload();
        }, 3000);
    })
    .catch(error => {
        console.error('Error removing from wishlist:', error);
        showToast('Failed to remove from wishlist: ' + error.message, 'error');
        if (error.message.includes('Unauthorized')) {
            window.location.href = '{{ url_for('user_login') }}';
        }
    });
}

// Add to Cart from Wishlist
function addToCartFromWishlist(wishlistId, productId) {
    console.log(`Adding to cart from wishlist: ${wishlistId}, product: ${productId}`);
    const wishlistCard = document.querySelector(`#wishlist-items .wishlist-card button[onclick="addToCartFromWishlist(${wishlistId}, ${productId})"]`).closest('.wishlist-card');
    const priceElement = wishlistCard.querySelector('.price');
    const discountedPriceKES = parseFloat(priceElement.getAttribute('data-discounted-price') || priceElement.getAttribute('data-price'));

    fetch('/api/cart', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
            product_id: productId, 
            quantity: 1,
            price: discountedPriceKES
        }),
        credentials: 'include'
    })
    .then(response => response.json().then(data => ({ status: response.status, body: data })))
    .then(({ status, body }) => {
        if (status >= 400) {
            throw new Error(body.error || 'Failed to add to cart');
        }
        return fetch(`/api/wishlist/${wishlistId}`, {
            method: 'DELETE',
            credentials: 'include'
        });
    })
    .then(response => response.json().then(data => ({ status: response.status, body: data })))
    .then(({ status, body }) => {
        if (status >= 400) {
            throw new Error(body.error || 'Failed to remove from wishlist');
        }
        showToast('Product moved to cart', 'success');
        setTimeout(() => {
            console.log('Reloading page after moving to cart');
            location.reload();
        }, 3000);
    })
    .catch(error => {
        console.error('Error moving to cart:', error);
        showToast('Failed to move product to cart: ' + error.message, 'error');
        if (error.message.includes('Unauthorized')) {
            window.location.href = '{{ url_for('user_login') }}';
        }
    });
}

// Update Cart Quantity
async function updateCartQuantity(productId, quantity) {
    console.log(`Updating cart quantity for product: ${productId}, quantity: ${quantity}`);
    if (quantity < 1) {
        showToast('Quantity must be at least 1', 'error');
        return;
    }
    const cartCard = document.querySelector(`.cart-card[data-product-id="${productId}"]`);
    const priceElement = cartCard.querySelector('.price');
    const discountedPriceKES = parseFloat(priceElement.getAttribute('data-discounted-price') || priceElement.getAttribute('data-price'));

    try {
        const response = await fetch('/api/cart', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                product_id: productId, 
                quantity: parseInt(quantity),
                price: discountedPriceKES
            }),
            credentials: 'include'
        });
        const data = await response.json();
        if (response.ok) {
            showToast(data.message || 'Quantity updated successfully', 'success');
            setTimeout(() => {
                console.log('Reloading page after updating quantity');
                location.reload();
            }, 3000);
        } else {
            showToast(data.error || 'Failed to update quantity', 'error');
            if (data.redirect) {
                window.location.href = data.redirect;
            }
        }
    } catch (error) {
        console.error('Error updating quantity:', error);
        showToast('Failed to update quantity: ' + error.message, 'error');
    }
}

// Remove from Cart
function removeFromCart(productId) {
    console.log(`Removing from cart: ${productId}`);
    fetch('/api/cart', {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ product_id: productId }),
        credentials: 'include'
    })
    .then(response => response.json().then(data => ({ status: response.status, body: data })))
    .then(({ status, body }) => {
        if (status >= 400) {
            throw new Error(body.error || 'Failed to remove from cart');
        }
        showToast(body.message || 'Removed from cart', 'success');
        setTimeout(() => {
            console.log('Reloading page after removing from cart');
            location.reload();
        }, 3000);
    })
    .catch(error => {
        console.error('Error removing from cart:', error);
        showToast('Failed to remove from cart: ' + error.message, 'error');
        if (error.message.includes('Unauthorized')) {
            window.location.href = '{{ url_for('user_login') }}';
        }
    });
}

// Cancel Order
function cancelOrder(orderId) {
    console.log(`Canceling order: ${orderId}`);
    if (confirm('Are you sure you want to cancel this order?')) {
        fetch(`/api/orders/${orderId}/cancel`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include'
        })
        .then(response => {
            console.log(`Cancel order response: ${response.status} ${response.statusText}, Content-Type: ${response.headers.get('content-type')}`);
            if (!response.ok && response.status === 401) {
                throw new Error('Unauthorized');
            }
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return response.json().then(data => ({ status: response.status, body: data }));
            }
            return response.text().then(text => {
                console.error('Non-JSON response:', text.slice(0, 100));
                throw new Error('Unexpected response');
            });
        })
        .then(({ status, body }) => {
            if (status >= 400) {
                throw new Error(body.error || 'Failed to cancel order');
            }
            showToast(body.message || 'Order canceled successfully', 'success');
            setTimeout(() => {
                console.log('Reloading page after canceling order');
                window.location.reload();
            }, 3000);
        })
        .catch(error => {
            console.error('Error canceling order:', error);
            showToast('Failed to cancel order: ' + error.message, 'error');
            if (error.message.includes('Unauthorized')) {
                window.location.href = '{{ url_for('user_login') }}';
            }
        });
    }
}

// Show Toast Notification
function showToast(message, type = 'success') {
    console.log(`Showing toast: ${message}, type: ${type}`);
    try {
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 p-4 rounded shadow-lg text-white z-[100] ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`;
        toast.style.opacity = '1';
        toast.style.transition = 'opacity 0.3s ease';
        toast.textContent = message;
        document.body.appendChild(toast);
        console.log('Toast appended to DOM:', toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => {
                toast.remove();
                console.log(`Toast removed: ${message}`);
            }, 300);
        }, 3000);
        setTimeout(() => {
            if (!document.body.contains(toast)) {
                console.warn('Toast not found in DOM, falling back to alert');
                window.alert(message);
            }
        }, 100);
    } catch (error) {
        console.error('Error displaying toast:', error);
        window.alert(message);
    }
}

// Populate Orders
async function populateOrders() {
    console.log('Populating orders');
    try {
        const response = await fetch('/api/orders', {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include'
        });
        if (!response.ok) {
            const data = await response.json();
            throw new Error(data.error || 'Failed to fetch orders');
        }
        const orders = await response.json();
        const orderItems = document.getElementById('order-items');
        if (orderItems) {
            orderItems.innerHTML = orders.length === 0
                ? '<div class="custom-card p-6"><p class="text-gray-600 text-lg">You have no orders.</p></div>'
                : orders.map(order => `
                    <div class="order-card flex flex-col gap-4 p-6 custom-card">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <div>
                                <h3 class="text-xl font-semibold text-gray-800">Order #${order.id}</h3>
                                <p class="text-gray-600 text-lg">Date: ${formatDate(order.created_at)}</p>
                                <p class="text-gray-600 text-lg">Total: <span class="price" data-price="${order.total}">${currentCurrency} ${order.total.toFixed(2)}</span></p>
                                <p class="text-gray-600 text-lg">Status: ${order.status}</p>
                            </div>
                            ${order.status === 'Pending' ? `<button class="action-btn bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700" onclick="cancelOrder(${order.id})">Cancel Order</button>` : ''}
                        </div>
                        <div class="border-t pt-4">
                            <h4 class="text-lg font-semibold text-gray-800 mb-2">Items</h4>
                            ${order.order_items.map(item => `
                                <div class="flex flex-col sm:flex-row items-center gap-4 mb-2">
                                    ${item.product ? `
                                        <img loading="lazy" src="/static/uploads/${item.product.image || 'placeholder.jpg'}" alt="${item.product.name}" class="w-20 h-20 object-cover rounded">
                                        <div class="flex-1">
                                            <p class="text-gray-800 font-medium">${item.product.name}</p>
                                            <p class="text-gray-600">Quantity: ${item.quantity}</p>
                                            ${item.product.discount && item.product.discount.percent > 0 ? `
                                                <p class="text-gray-600">Price: <span class="price" data-price="${item.product.price}" data-discounted-price="${(item.product.price * (1 - item.product.discount.percent / 100)).toFixed(2)}" data-has-discount="true">${currentCurrency} ${(item.product.price * (1 - item.product.discount.percent / 100)).toFixed(2)}</span></p>
                                                <p class="text-gray-500 line-through text-sm" data-original-price="${item.product.price}">${currentCurrency} ${item.product.price.toFixed(2)}</p>
                                            ` : `
                                                <p class="text-gray-600">Price: <span class="price" data-price="${item.product.price}" data-has-discount="false">${currentCurrency} ${item.product.price.toFixed(2)}</span></p>
                                            `}
                                        </div>
                                    ` : `
                                        <div class="flex-1">
                                            <p class="text-gray-600">Product not found (ID: ${item.product_id})</p>
                                            <p class="text-gray-600">Quantity: ${item.quantity}</p>
                                        </div>
                                    `}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
        }
        updatePrices();
    } catch (error) {
        console.error('Error fetching orders:', error);
        if (error.message.includes('Failed to fetch orders') || error.message.includes('Unauthorized')) {
            showToast('welcome');
        }
        if (error.message.includes('Unauthorized')) {
            window.location.href = '{{ url_for('user_login') }}';
        }
    }
}

// Toggle Message Code Field
function toggleMessageCode() {
    console.log('Toggling message code visibility');
    const paymentMethod = document.querySelector('input[name="payment_method"]:checked');
    if (paymentMethod) {
        const messageCodeSection = document.getElementById('message-code-section');
        if (messageCodeSection) {
            messageCodeSection.style.display = paymentMethod.value === 'immediate' ? 'block' : 'none';
            if (paymentMethod.value !== 'immediate') {
                const messageCodeInput = document.querySelector('input[name="message_code"]');
                if (messageCodeInput) {
                    messageCodeInput.value = '';
                }
            }
        }
    }
}

// Update Payment Details
function updatePaymentDetails() {
    console.log('Updating payment details');
    const paymentMethod = document.querySelector('input[name="payment_method"]:checked');
    if (paymentMethod) {
        const immediateDetails = document.getElementById('immediate-payment-details');
        const deliveryDetails = document.getElementById('delivery-payment-details');
        if (immediateDetails && deliveryDetails) {
            if (paymentMethod.value === 'immediate') {
                immediateDetails.classList.remove('hidden');
                deliveryDetails.classList.add('hidden');
            } else {
                immediateDetails.classList.add('hidden');
                deliveryDetails.classList.remove('hidden');
            }
        }
    }
}

// Place Order
function placeOrder(event) {
    event.preventDefault();
    console.log('Placing order');
    const form = event.target;
    const paymentMethod = document.querySelector('input[name="payment_method"]:checked');
    const data = {
        name: form.name.value,
        phone_number: form.phone_number.value,
        address: {
            street: form.street.value,
            city: form.city.value,
            country: form.country.value,
            postal_code: form.postal_code.value,
        },
        payment_method: paymentMethod ? paymentMethod.value : null,
        message_code: paymentMethod && paymentMethod.value === 'immediate' ? form.message_code.value : null
    };
    fetch('/api/orders', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
        credentials: 'include'
    })
    .then(response => response.json().then(data => ({ status: response.status, body: data })))
    .then(({ status, body }) => {
        if (status >= 400) {
            throw new Error(body.error || 'Failed to place order');
        }
        showToast(body.message || 'Order placed successfully', 'success');
        closeModal('checkout-modal');
        setTimeout(() => {
            console.log('Reloading page after placing order');
            location.reload();
        }, 3000);
    })
    .catch(error => {
        console.error('Error placing order:', error);
        showToast('Failed to place order: ' + error.message, 'error');
        if (error.message.includes('Unauthorized')) {
            window.location.href = '{{ url_for('user_login') }}';
        }
    });
}

// Mobile Navbar Toggle
document.getElementById('nav-toggler')?.addEventListener('click', () => {
    console.log('Toggling mobile navbar');
    const sidebar = document.getElementById('mobile-sidebar');
    const icon = document.querySelector('#nav-toggler i');
    if (sidebar && icon) {
        sidebar.classList.toggle('-translate-x-full');
        icon.classList.toggle('fa-bars');
        icon.classList.toggle('fa-times');
        icon.classList.add('animate-rotateToggle');
        setTimeout(() => icon.classList.remove('animate-rotateToggle'), 300);
    }
});

// Close Mobile Sidebar
document.getElementById('close-sidebar')?.addEventListener('click', () => {
    console.log('Closing mobile sidebar');
    const sidebar = document.getElementById('mobile-sidebar');
    const icon = document.querySelector('#nav-toggler i');
    if (sidebar && icon) {
        sidebar.classList.add('-translate-x-full');
        icon.classList.add('fa-bars');
        icon.classList.remove('fa-times');
        icon.classList.add('animate-rotateToggle');
        setTimeout(() => icon.classList.remove('animate-rotateToggle'), 300);
    }
});

// Mobile Search Toggle
document.getElementById('mobile-search-icon')?.addEventListener('click', () => {
    console.log('Toggling mobile search');
    const searchBar = document.getElementById('mobile-search-bar');
    const icon = document.getElementById('mobile-search-icon');
    if (searchBar && icon) {
        searchBar.classList.toggle('active');
        icon.classList.add('animate-bounce');
        setTimeout(() => icon.classList.remove('animate-bounce'), 200);
    }
});

// Close Modals on Outside Click
document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            console.log(`Closing modal ${modal.id} on outside click`);
            closeModal(modal.id);
        }
    });
});

// Toggle Password Visibility
function togglePassword(inputId) {
    console.log(`Toggling password visibility for ${inputId}`);
    const input = document.getElementById(inputId);
    const icon = input?.nextElementSibling;
    if (!input || !icon) {
        console.error(`Input or icon not found for ${inputId}`);
        return;
    }
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
    icon.classList.add('animate-pulse');
    setTimeout(() => icon.classList.remove('animate-pulse'), 300);
}

// Change Password
async function changePassword(event) {
    event.preventDefault();
    console.log('Change password function called');
    const form = document.getElementById('password-form');
    if (!form) {
        console.error('Password form not found');
        showToast('Form error, please try again', 'error');
        return;
    }
    const oldPassword = form.querySelector('#old-password')?.value;
    const newPassword = form.querySelector('#new-password')?.value;
    const confirmPassword = form.querySelector('#confirm-password')?.value;

    if (!oldPassword || !newPassword || !confirmPassword) {
        console.log('Validation failed: Missing password fields');
        showToast('All password fields are required', 'error');
        return;
    }
    if (newPassword.length < 8) {
        console.log('Validation failed: New password too short');
        showToast('New password must be at least 8 characters long', 'error');
        return;
    }
    if (newPassword !== confirmPassword) {
        console.log('Validation failed: Passwords do not match');
        showToast('New passwords do not match', 'error');
        return;
    }

    try {
        console.log('Sending request to /api/change_password');
        const response = await fetch('/api/change_password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                old_password: oldPassword,
                new_password: newPassword,
                confirm_password: confirmPassword
            }),
            credentials: 'include'
        });
        console.log(`Response from /api/change_password: ${response.status}`);
        const data = await response.json();
        console.log('Response data:', data);
        if (!response.ok) {
            throw new Error(data.error || 'Failed to change password');
        }
        showToast(data.message || 'Password changed successfully', 'success');
        console.log('Password changed successfully');
        closeModal('password-modal');
        setTimeout(() => {
            console.log('Reloading page after password change');
            location.reload();
        }, 3000);
    } catch (error) {
        console.error('Error changing password:', error);
        showToast('Failed to change password: ' + error.message, 'error');
        if (error.message.includes('Unauthorized')) {
            window.location.href = '{{ url_for('user_login') }}';
        }
    }
}

// Run on page load
document.addEventListener('DOMContentLoaded', () => {
    console.log('Page loaded, initializing account page');
    try {
        const passwordButton = document.getElementById('change-password-btn');
        if (passwordButton) {
            console.log('Change Password button found, adding click listener');
            passwordButton.addEventListener('click', (e) => {
                e.preventDefault();
                console.log('Change Password button clicked, opening password-modal');
                openModal('password-modal');
            });
        } else {
            console.error('Change Password button (#change-password-btn) not found');
            showToast('Change Password button not found', 'error');
        }

        function initializePasswordForm() {
            const passwordForm = document.getElementById('password-form');
            const submitButton = document.getElementById('change-password-submit');
            if (passwordForm) {
                console.log('Password form found, adding submit listener');
                passwordForm.addEventListener('submit', (e) => {
                    console.log('Password form submit event triggered');
                    changePassword(e);
                });
            } else {
                console.error('Password form (#password-form) not found');
                showToast('Password form not found', 'error');
            }
            if (submitButton) {
                console.log('Change Password submit button found, adding click listener');
                submitButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('Change Password submit button clicked');
                    if (passwordForm) {
                        changePassword({ preventDefault: () => {}, target: passwordForm });
                    } else {
                        console.error('Password form not found during submit');
                        showToast('Form error, please try again', 'error');
                    }
                });
            } else {
                console.error('Change Password submit button (#change-password-submit) not found');
                showToast('Submit button not found', 'error');
            }
        }

        initializePasswordForm();

        const passwordModal = document.getElementById('password-modal');
        if (passwordModal) {
            const observer = new MutationObserver(() => {
                if (passwordModal.classList.contains('open')) {
                    console.log('Password modal opened, re-initializing form listeners');
                    initializePasswordForm();
                }
            });
            observer.observe(passwordModal, { attributes: true, attributeFilter: ['class'] });
        }

        updatePrices();
        toggleMessageCode();
        populateOrders();
    } catch (error) {
        console.error('Error during page initialization:', error);
        showToast('Page initialization failed: ' + error.message, 'error');
    }
});
</script>
</body>
</html>